<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bolão Piauizão Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap');

        * {
            font-family: 'Montserrat', sans-serif;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            transition: all 0.3s ease;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Firebase Configuration -->
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBpQX5H6O6e6pLrT9v6Qk6wZ6QwZ6QwZ6Q",
            authDomain: "bolao-piauizao-pro.firebaseapp.com",
            projectId: "bolao-piauizao-pro",
            storageBucket: "bolao-piauizao-pro.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890abcdef"
        };

        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();
        
        // Habilitar persistência offline
        db.enablePersistence()
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.warn('Persistência offline: múltiplas abas abertas');
                } else if (err.code == 'unimplemented') {
                    console.warn('Persistência offline não suportada');
                }
            });
    </script>

    <!-- Aplicação Principal -->
    <div id="app" class="min-h-screen">
        <!-- Header -->
        <header class="bg-gradient-to-r from-green-600 to-blue-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="flex items-center space-x-3 mb-4 md:mb-0">
                        <i class="fas fa-futbol text-3xl"></i>
                        <div>
                            <h1 class="text-2xl md:text-3xl font-bold">Bolão Piauizão Pro</h1>
                            <p class="text-sm opacity-90">Campeonato Piauiense de Futebol</p>
                        </div>
                    </div>
                    <div class="flex space-x-4">
                        <button onclick="showSection('jogos')"
                            class="px-4 py-2 rounded-lg hover:bg-white/20 transition">
                            <i class="fas fa-calendar-alt mr-2"></i>Jogos
                        </button>
                        <button onclick="showSection('ranking')"
                            class="px-4 py-2 rounded-lg hover:bg-white/20 transition">
                            <i class="fas fa-trophy mr-2"></i>Ranking
                        </button>
                        <button onclick="showSection('admin')"
                            class="px-4 py-2 rounded-lg hover:bg-white/20 transition">
                            <i class="fas fa-lock mr-2"></i>Admin
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Seção Principal -->
        <main class="container mx-auto px-4 py-8">
            <!-- Seção Jogos (Padrão) -->
            <section id="jogos-section" class="fade-in">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-calendar-day mr-2"></i>Rodada <span id="current-round">1</span>
                    </h2>
                    <div class="flex space-x-2">
                        <button onclick="changeRound(-1)" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button onclick="changeRound(1)" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Filtro de Rodadas -->
                <div class="mb-6 overflow-x-auto">
                    <div class="flex space-x-2 pb-2" id="rounds-filter">
                        <!-- Rodadas serão carregadas dinamicamente -->
                    </div>
                </div>

                <!-- Lista de Jogos -->
                <div id="games-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Jogos serão carregados dinamicamente -->
                </div>
            </section>

            <!-- Seção Ranking -->
            <section id="ranking-section" class="hidden fade-in">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">
                        <i class="fas fa-trophy mr-2 text-yellow-500"></i>Classificação Geral
                    </h2>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-3 px-4 text-left">Posição</th>
                                    <th class="py-3 px-4 text-left">Participante</th>
                                    <th class="py-3 px-4 text-left">Pontos</th>
                                    <th class="py-3 px-4 text-left">Acertos</th>
                                </tr>
                            </thead>
                            <tbody id="ranking-table">
                                <!-- Ranking será carregado dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Estatísticas -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="font-bold text-lg mb-4">Melhores da Rodada</h3>
                        <div id="round-best"></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="font-bold text-lg mb-4">Pontuação Média</h3>
                        <div class="text-3xl font-bold text-blue-600" id="average-points">0.0</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="font-bold text-lg mb-4">Total de Palpites</h3>
                        <div class="text-3xl font-bold text-green-600" id="total-guesses">0</div>
                    </div>
                </div>
            </section>

            <!-- Seção Admin (Protegida) -->
            <section id="admin-section" class="hidden">
                <!-- Tela de Login -->
                <div id="admin-login" class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
                        <i class="fas fa-lock mr-2"></i>Acesso Administrativo
                    </h2>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">Senha</label>
                        <input type="password" id="admin-password"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Digite a senha de administrador">
                    </div>
                    <button onclick="adminLogin()"
                        class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-bold">
                        <i class="fas fa-sign-in-alt mr-2"></i>Entrar
                    </button>
                    <p class="text-sm text-gray-500 mt-4 text-center">
                        Senha padrão inicial: admin123
                    </p>
                    <div id="login-error" class="mt-4 text-red-600 text-center hidden"></div>
                </div>

                <!-- Painel Admin (Após Login) -->
                <div id="admin-panel" class="hidden">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-cogs mr-2"></i>Painel Administrativo
                        </h2>
                        <button onclick="adminLogout()"
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                            <i class="fas fa-sign-out-alt mr-2"></i>Sair
                        </button>
                    </div>

                    <!-- Abas do Admin -->
                    <div class="mb-6 border-b">
                        <div class="flex space-x-4">
                            <button onclick="showAdminTab('manage-games')"
                                class="admin-tab active px-4 py-2 font-medium border-b-2 border-blue-600 text-blue-600">
                                <i class="fas fa-futbol mr-2"></i>Gerenciar Jogos
                            </button>
                            <button onclick="showAdminTab('manage-participants')"
                                class="admin-tab px-4 py-2 font-medium text-gray-600 hover:text-blue-600">
                                <i class="fas fa-users mr-2"></i>Participantes
                            </button>
                            <button onclick="showAdminTab('manage-guesses')"
                                class="admin-tab px-4 py-2 font-medium text-gray-600 hover:text-blue-600">
                                <i class="fas fa-edit mr-2"></i>Palpites
                            </button>
                            <button onclick="showAdminTab('change-password')"
                                class="admin-tab px-4 py-2 font-medium text-gray-600 hover:text-blue-600">
                                <i class="fas fa-key mr-2"></i>Alterar Senha
                            </button>
                        </div>
                    </div>

                    <!-- Conteúdo das Abas -->
                    <div id="admin-content">
                        <!-- Aba: Gerenciar Jogos -->
                        <div id="manage-games" class="admin-tab-content">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold">Cadastrar Novo Jogo</h3>
                                <button onclick="showGameForm()"
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                                    <i class="fas fa-plus mr-2"></i>Novo Jogo
                                </button>
                            </div>

                            <!-- Formulário de Jogo -->
                            <div id="game-form" class="hidden bg-white rounded-xl shadow-lg p-6 mb-8">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-gray-700 mb-2">Rodada</label>
                                        <input type="number" id="game-round" class="w-full px-4 py-2 border rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 mb-2">Data e Hora</label>
                                        <input type="datetime-local" id="game-date"
                                            class="w-full px-4 py-2 border rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 mb-2">Time Mandante</label>
                                        <input type="text" id="home-team" class="w-full px-4 py-2 border rounded-lg"
                                            placeholder="Ex: Flamengo-PI">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 mb-2">Time Visitante</label>
                                        <input type="text" id="away-team" class="w-full px-4 py-2 border rounded-lg"
                                            placeholder="Ex: River-PI">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-gray-700 mb-2">Estádio</label>
                                        <input type="text" id="game-stadium" class="w-full px-4 py-2 border rounded-lg"
                                            placeholder="Ex: Albertão">
                                    </div>
                                </div>
                                <div class="flex justify-end space-x-4 mt-6">
                                    <button onclick="hideGameForm()"
                                        class="px-6 py-2 bg-gray-300 rounded-lg hover:bg-gray-400 transition">
                                        Cancelar
                                    </button>
                                    <button onclick="saveGame()"
                                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                        <i class="fas fa-save mr-2"></i>Salvar Jogo
                                    </button>
                                </div>
                            </div>

                            <!-- Lista de Jogos para Edição -->
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h4 class="font-bold text-lg mb-4">Jogos Cadastrados</h4>
                                <div id="admin-games-list">
                                    <!-- Jogos serão listados aqui -->
                                </div>
                            </div>
                        </div>

                        <!-- Aba: Gerenciar Participantes -->
                        <div id="manage-participants" class="admin-tab-content hidden">
                            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                                <h3 class="text-xl font-bold mb-6">Cadastrar Participante</h3>
                                <div class="flex space-x-4">
                                    <input type="text" id="new-participant"
                                        class="flex-grow px-4 py-2 border rounded-lg"
                                        placeholder="Nome do participante">
                                    <button onclick="addParticipant()"
                                        class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                                        <i class="fas fa-plus mr-2"></i>Adicionar
                                    </button>
                                </div>
                            </div>

                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h4 class="font-bold text-lg mb-4">Participantes Cadastrados</h4>
                                <div id="participants-list">
                                    <!-- Participantes serão listados aqui -->
                                </div>
                            </div>
                        </div>

                        <!-- Aba: Gerenciar Palpites -->
                        <div id="manage-guesses" class="admin-tab-content hidden">
                            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                                <h3 class="text-xl font-bold mb-4">Adicionar Palpite</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                    <div>
                                        <label class="block text-gray-700 mb-2">Jogo</label>
                                        <select id="guess-game" class="w-full px-4 py-2 border rounded-lg">
                                            <!-- Jogos serão carregados aqui -->
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 mb-2">Participante</label>
                                        <select id="guess-participant" class="w-full px-4 py-2 border rounded-lg">
                                            <!-- Participantes serão carregados aqui -->
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 mb-2">Palpite (Ex: 2x1)</label>
                                        <input type="text" id="guess-score" class="w-full px-4 py-2 border rounded-lg"
                                            placeholder="Ex: 2x1">
                                    </div>
                                </div>
                                <button onclick="addGuess()"
                                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                    <i class="fas fa-plus mr-2"></i>Adicionar Palpite
                                </button>
                            </div>

                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h4 class="font-bold text-lg mb-4">Palpites Registrados</h4>
                                <div id="guesses-list">
                                    <!-- Palpites serão listados aqui -->
                                </div>
                            </div>
                        </div>

                        <!-- Aba: Alterar Senha -->
                        <div id="change-password" class="admin-tab-content hidden">
                            <div class="bg-white rounded-xl shadow-lg p-6 max-w-md mx-auto">
                                <h3 class="text-xl font-bold mb-6">Alterar Senha do Administrador</h3>
                                <div class="mb-4">
                                    <label class="block text-gray-700 mb-2">Senha Atual</label>
                                    <input type="password" id="current-password"
                                        class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div class="mb-4">
                                    <label class="block text-gray-700 mb-2">Nova Senha</label>
                                    <input type="password" id="new-password" class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div class="mb-6">
                                    <label class="block text-gray-700 mb-2">Confirmar Nova Senha</label>
                                    <input type="password" id="confirm-password"
                                        class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <button onclick="changeAdminPassword()"
                                    class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-bold">
                                    <i class="fas fa-key mr-2"></i>Alterar Senha
                                </button>
                                <div id="password-error" class="mt-4 text-red-600 text-center hidden"></div>
                                <div id="password-success" class="mt-4 text-green-600 text-center hidden"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Modal para Placar Oficial -->
        <div id="score-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 slide-in">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold">Definir Placar Oficial</h3>
                    <button onclick="hideScoreModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="mb-4 text-center">
                    <div id="modal-game-info" class="text-lg font-bold mb-6"></div>
                    <div class="flex items-center justify-center space-x-6">
                        <div class="text-center">
                            <div id="modal-home-team" class="font-bold mb-2"></div>
                            <input type="number" id="official-home-score"
                                class="w-20 h-20 text-3xl text-center border-2 border-blue-500 rounded-lg">
                        </div>
                        <div class="text-3xl font-bold">x</div>
                        <div class="text-center">
                            <div id="modal-away-team" class="font-bold mb-2"></div>
                            <input type="number" id="official-away-score"
                                class="w-20 h-20 text-3xl text-center border-2 border-blue-500 rounded-lg">
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-8">
                    <button onclick="hideScoreModal()"
                        class="px-6 py-2 bg-gray-300 rounded-lg hover:bg-gray-400 transition">
                        Cancelar
                    </button>
                    <button onclick="saveOfficialScore()"
                        class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold">
                        <i class="fas fa-check mr-2"></i>Salvar Placar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script Principal -->
    <script>
        // Variáveis globais
        let currentRound = 1;
        let maxRounds = 10;
        let isAdmin = false;
        let currentGameId = null;
        let games = [];
        let participants = [];
        let guesses = [];
        let ranking = [];

        // Inicializar aplicação
        document.addEventListener('DOMContentLoaded', async function () {
            await initializeApp();
            await loadAllData();
            showSection('jogos');
        });

        // Função de hash simples mas eficaz
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Converte para 32-bit
            }
            return Math.abs(hash).toString(16);
        }

        // Inicializar Firebase e verificar autenticação
        async function initializeApp() {
            try {
                // Verificar se há senha salva
                const adminRef = db.collection('admin').doc('password');
                const doc = await adminRef.get();

                if (!doc.exists) {
                    // Criar senha padrão (admin123) com hash
                    const defaultPassword = 'admin123';
                    const hash = simpleHash(defaultPassword);

                    await adminRef.set({
                        password: hash,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        defaultPassword: 'admin123' // Armazenamos a senha em texto para facilitar
                    });

                    console.log('Senha administrativa criada:', hash);
                } else {
                    console.log('Senha administrativa já existe no banco');
                    console.log('Hash armazenado:', doc.data().password);
                    console.log('Teste hash admin123:', simpleHash('admin123'));
                }
            } catch (error) {
                console.error('Erro ao inicializar:', error);
                console.error('Detalhes do erro:', error.code, error.message);
                // Não mostrar alerta, deixar continuar mesmo com erro de inicialização
                console.warn('Sistema inicializado com aviso. Verifique as permissões do Firestore.');
            }
        }

        // Carregar todos os dados
        async function loadAllData() {
            try {
                console.log('Iniciando carregamento de dados...');
                await loadGames();
                console.log('Jogos carregados:', games.length);
                await loadParticipants();
                console.log('Participantes carregados:', participants.length);
                await loadGuesses();
                console.log('Palpites carregados:', guesses.length);
                calculateRanking();
                updateRoundsFilter();
                renderGames();
                updateAdminLists();
                console.log('Todos os dados carregados com sucesso');
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }

        // Carregar jogos do Firestore
        async function loadGames() {
            try {
                try {
                    const snapshot = await db.collection('games')
                        .orderBy('round')
                        .orderBy('date')
                        .get();

                    games = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        games.push({
                            id: doc.id,
                            ...data
                        });
                    });
                    
                    // Salvar no localStorage como backup
                    localStorage.setItem('games', JSON.stringify(games));
                } catch (firebaseError) {
                    console.warn('Erro ao carregar jogos do Firestore:', firebaseError.message);
                    console.log('Carregando jogos do localStorage...');
                    
                    const cachedGames = localStorage.getItem('games');
                    games = cachedGames ? JSON.parse(cachedGames) : [];
                }

                // Encontrar maior rodada
                if (games.length > 0) {
                    maxRounds = Math.max(...games.map(g => g.round));
                    currentRound = maxRounds;
                    document.getElementById('current-round').textContent = currentRound;
                }
            } catch (error) {
                console.error('Erro ao carregar jogos:', error);
                games = [];
            }
        }

        // Carregar participantes
        async function loadParticipants() {
            try {
                try {
                    const snapshot = await db.collection('participants').get();
                    participants = [];
                    snapshot.forEach(doc => {
                        participants.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Salvar no localStorage como backup
                    localStorage.setItem('participants', JSON.stringify(participants));
                } catch (firebaseError) {
                    console.warn('Erro ao carregar participantes do Firestore:', firebaseError.message);
                    console.log('Carregando participantes do localStorage...');
                    
                    const cachedParticipants = localStorage.getItem('participants');
                    participants = cachedParticipants ? JSON.parse(cachedParticipants) : [];
                }
            } catch (error) {
                console.error('Erro ao carregar participantes:', error);
                participants = [];
            }
        }

        // Carregar palpites
        async function loadGuesses() {
            try {
                try {
                    const snapshot = await db.collection('guesses').get();
                    guesses = [];
                    snapshot.forEach(doc => {
                        guesses.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Salvar no localStorage como backup
                    localStorage.setItem('guesses', JSON.stringify(guesses));
                } catch (firebaseError) {
                    console.warn('Erro ao carregar palpites do Firestore:', firebaseError.message);
                    console.log('Carregando palpites do localStorage...');
                    
                    const cachedGuesses = localStorage.getItem('guesses');
                    guesses = cachedGuesses ? JSON.parse(cachedGuesses) : [];
                }
            } catch (error) {
                console.error('Erro ao carregar palpites:', error);
                guesses = [];
            }
        }

        // Calcular ranking
        function calculateRanking() {
            // Inicializar pontuação dos participantes
            const points = {};
            const correctGuesses = {};

            participants.forEach(p => {
                points[p.id] = 0;
                correctGuesses[p.id] = 0;
            });

            // Calcular pontos para cada palpite
            guesses.forEach(guess => {
                const game = games.find(g => g.id === guess.gameId);
                if (game && game.officialScore) {
                    const [homeScore, awayScore] = game.officialScore.split('x').map(Number);
                    const [guessHome, guessAway] = guess.score.split('x').map(Number);

                    // Verificar se acertou o resultado
                    let pointsEarned = 0;

                    if (homeScore === awayScore && guessHome === guessAway) {
                        // Empate correto
                        pointsEarned = 1;
                    } else if ((homeScore > awayScore && guessHome > guessAway) ||
                        (homeScore < awayScore && guessHome < guessAway)) {
                        // Vencedor correto
                        pointsEarned = 3;
                    }

                    if (points[guess.participantId] !== undefined) {
                        points[guess.participantId] += pointsEarned;
                        if (pointsEarned > 0) {
                            correctGuesses[guess.participantId] = (correctGuesses[guess.participantId] || 0) +
                            1;
                        }
                    }
                }
            });

            // Criar array de ranking
            ranking = participants.map(p => ({
                id: p.id,
                name: p.name,
                points: points[p.id] || 0,
                correctGuesses: correctGuesses[p.id] || 0
            })).sort((a, b) => b.points - a.points);

            // Atualizar interface
            updateRankingDisplay();
        }

        // Atualizar display do ranking
        function updateRankingDisplay() {
            const table = document.getElementById('ranking-table');
            table.innerHTML = '';

            ranking.forEach((p, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                row.innerHTML = `
                    <td class="py-3 px-4">
                        <div class="flex items-center">
                            <span class="font-bold ${index < 3 ? 'text-yellow-500 text-lg' : 'text-gray-700'}">
                                ${index + 1}º
                            </span>
                            ${index < 3 ? '<i class="fas fa-crown ml-2 text-yellow-500"></i>' : ''}
                        </div>
                    </td>
                    <td class="py-3 px-4 font-medium">${p.name}</td>
                    <td class="py-3 px-4">
                        <span class="font-bold text-blue-600">${p.points}</span> pts
                    </td>
                    <td class="py-3 px-4">
                        <span class="font-bold text-green-600">${p.correctGuesses}</span> acertos
                    </td>
                `;
                table.appendChild(row);
            });

            // Atualizar estatísticas
            const totalPoints = ranking.reduce((sum, p) => sum + p.points, 0);
            const average = ranking.length > 0 ? (totalPoints / ranking.length).toFixed(1) : '0.0';
            document.getElementById('average-points').textContent = average;
            document.getElementById('total-guesses').textContent = guesses.length;
        }

        // Renderizar jogos
        function renderGames() {
            const container = document.getElementById('games-container');
            const filteredGames = games.filter(game => game.round === currentRound);

            if (filteredGames.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-calendar-times text-5xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">Nenhum jogo cadastrado para esta rodada</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';

            filteredGames.forEach(game => {
                const gameGuesses = guesses.filter(g => g.gameId === game.id);
                const gameElement = document.createElement('div');
                gameElement.className = 'bg-white rounded-xl shadow-lg card-hover overflow-hidden';

                // Formatar data
                let dateStr = 'Data não definida';
                let timeStr = '';

                if (game.date) {
                    try {
                        const gameDate = game.date.toDate ? game.date.toDate() : new Date(game.date);
                        dateStr = gameDate.toLocaleDateString('pt-BR');
                        timeStr = gameDate.toLocaleTimeString('pt-BR', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } catch (e) {
                        console.error('Erro ao formatar data:', e);
                    }
                }

                const hasOfficialScore = game.officialScore ? true : false;
                const homeScore = hasOfficialScore ? game.officialScore.split('x')[0] : '0';
                const awayScore = hasOfficialScore ? game.officialScore.split('x')[1] : '0';
                const homeScoreColor = hasOfficialScore ? 'text-green-600' : 'text-gray-300';
                const awayScoreColor = hasOfficialScore ? 'text-green-600' : 'text-gray-300';

                // Construir o HTML do jogo
                let gameHtml = `
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <span class="inline-block px-3 py-1 bg-blue-100 text-blue-600 rounded-full text-sm font-medium">
                                    Rodada ${game.round}
                                </span>
                                <p class="text-gray-500 text-sm mt-1">
                                    <i class="far fa-clock mr-1"></i>${dateStr} ${timeStr ? ' - ' + timeStr : ''}
                                </p>
                            </div>
                `;

                if (isAdmin) {
                    gameHtml += `
                        <div class="flex space-x-2">
                            <button onclick="editGame('${game.id}')" 
                                    class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteGame('${game.id}')" 
                                    class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                }

                gameHtml += `
                        </div>
                        
                        <div class="flex justify-between items-center mb-6">
                            <div class="text-center">
                                <div class="font-bold text-lg mb-2">${game.homeTeam}</div>
                                <div class="text-3xl font-bold ${homeScoreColor}">
                                    ${homeScore}
                                </div>
                            </div>
                            <div class="text-xl font-bold text-gray-500">x</div>
                            <div class="text-center">
                                <div class="font-bold text-lg mb-2">${game.awayTeam}</div>
                                <div class="text-3xl font-bold ${awayScoreColor}">
                                    ${awayScore}
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center text-gray-600 mb-4">
                            <i class="fas fa-stadium mr-2"></i>${game.stadium || 'Estádio não definido'}
                        </div>
                `;

                if (isAdmin && !hasOfficialScore) {
                    gameHtml += `
                        <button onclick="showScoreModal('${game.id}')" 
                                class="w-full mt-4 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
                            <i class="fas fa-check-circle mr-2"></i>Definir Placar
                        </button>
                    `;
                }

                gameHtml += `
                        <div class="mt-6 pt-4 border-t">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-bold text-gray-700">
                                    <i class="fas fa-users mr-2"></i>Palpites (${gameGuesses.length})
                                </h4>
                `;

                if (isAdmin) {
                    gameHtml += `
                                <button onclick="showGuessForm('${game.id}')" 
                                        class="text-sm text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-plus mr-1"></i>Adicionar
                                </button>
                    `;
                }

                gameHtml += `
                            </div>
                            <div class="space-y-2 max-h-40 overflow-y-auto">
                `;

                // Adicionar palpites
                gameGuesses.forEach(guess => {
                    const participant = participants.find(p => p.id === guess.participantId);
                    const guessPoints = hasOfficialScore ? calculateGuessPoints(game, guess) : 0;
                    const pointsText = hasOfficialScore ? ` (${guessPoints}pts)` : '';
                    let guessColor = 'text-blue-600';

                    if (hasOfficialScore) {
                        guessColor = guessPoints > 0 ? 'text-green-600' : 'text-red-600';
                    }

                    gameHtml += `
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                    <span class="font-medium">${participant ? participant.name : 'Desconhecido'}</span>
                                    <span class="font-bold ${guessColor}">
                                        ${guess.score}${pointsText}
                                    </span>
                    `;

                    if (isAdmin) {
                        gameHtml += `
                                    <button onclick="deleteGuess('${guess.id}')" 
                                            class="text-red-500 hover:text-red-700">
                                        <i class="fas fa-times"></i>
                                    </button>
                        `;
                    }

                    gameHtml += `
                                </div>
                    `;
                });

                gameHtml += `
                            </div>
                        </div>
                    </div>
                `;

                gameElement.innerHTML = gameHtml;
                container.appendChild(gameElement);
            });
        }

        // Calcular pontos de um palpite
        function calculateGuessPoints(game, guess) {
            if (!game.officialScore) return 0;

            const [homeScore, awayScore] = game.officialScore.split('x').map(Number);
            const [guessHome, guessAway] = guess.score.split('x').map(Number);

            if (homeScore === awayScore && guessHome === guessAway) {
                return 1;
            } else if ((homeScore > awayScore && guessHome > guessAway) ||
                (homeScore < awayScore && guessHome < guessAway)) {
                return 3;
            }
            return 0;
        }

        // Atualizar filtro de rodadas
        function updateRoundsFilter() {
            const container = document.getElementById('rounds-filter');
            container.innerHTML = '';

            for (let i = 1; i <= maxRounds; i++) {
                const button = document.createElement('button');
                button.className = `px-4 py-2 rounded-lg transition whitespace-nowrap ${i === currentRound ? 
                    'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'}`;
                button.textContent = `Rodada ${i}`;
                button.onclick = () => {
                    currentRound = i;
                    document.getElementById('current-round').textContent = i;
                    updateRoundsFilter();
                    renderGames();
                };
                container.appendChild(button);
            }
        }

        // Mudar rodada
        function changeRound(delta) {
            const newRound = currentRound + delta;
            if (newRound >= 1 && newRound <= maxRounds) {
                currentRound = newRound;
                document.getElementById('current-round').textContent = currentRound;
                updateRoundsFilter();
                renderGames();
            }
        }

        // Mostrar seção
        function showSection(section) {
            // Esconder todas as seções
            document.getElementById('jogos-section').classList.add('hidden');
            document.getElementById('ranking-section').classList.add('hidden');
            document.getElementById('admin-section').classList.add('hidden');

            // Mostrar seção selecionada
            document.getElementById(`${section}-section`).classList.remove('hidden');

            // Se for admin e não estiver logado, mostrar login
            if (section === 'admin') {
                if (!isAdmin) {
                    document.getElementById('admin-login').classList.remove('hidden');
                    document.getElementById('admin-panel').classList.add('hidden');
                    document.getElementById('admin-password').value = '';
                    document.getElementById('login-error').classList.add('hidden');
                } else {
                    document.getElementById('admin-login').classList.add('hidden');
                    document.getElementById('admin-panel').classList.remove('hidden');
                    showAdminTab('manage-games');
                }
            }

            // Se for ranking, atualizar dados
            if (section === 'ranking') {
                calculateRanking();
            }
        }

        // ADMIN FUNCTIONS - SISTEMA SIMPLIFICADO E FUNCIONAL

        // Login do admin
        async function adminLogin() {
            const password = document.getElementById('admin-password').value;
            const errorDiv = document.getElementById('login-error');

            if (!password) {
                errorDiv.textContent = 'Digite a senha!';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                let isValidPassword = false;
                
                try {
                    // Tentar conectar ao Firestore
                    const adminRef = db.collection('admin').doc('password');
                    const doc = await adminRef.get();

                    if (!doc.exists) {
                        // Criar senha padrão se não existir
                        const hash = simpleHash('admin123');
                        await adminRef.set({
                            password: hash,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            defaultPassword: 'admin123'
                        });

                        // Salvar no localStorage como backup
                        localStorage.setItem('adminPassword', hash);
                        console.log('Senha criada e salva no localStorage');

                        // Tentar login novamente
                        const newDoc = await adminRef.get();
                        isValidPassword = simpleHash(password) === newDoc.data().password;
                    } else {
                        const storedHash = doc.data().password;
                        const inputHash = simpleHash(password);

                        console.log('Hash da senha digitada:', inputHash);
                        console.log('Hash armazenado:', storedHash);

                        isValidPassword = inputHash === storedHash;
                        
                        // Sincronizar com localStorage
                        localStorage.setItem('adminPassword', storedHash);
                    }
                } catch (firebaseError) {
                    console.warn('Erro ao conectar ao Firestore:', firebaseError.message);
                    console.log('Tentando usar localStorage como fallback...');
                    
                    // Fallback: usar localStorage
                    const localPassword = localStorage.getItem('adminPassword');
                    const inputHash = simpleHash(password);
                    
                    if (localPassword) {
                        isValidPassword = inputHash === localPassword;
                        console.log('Usando autenticação offline (localStorage)');
                    } else {
                        // Se nem localStorage tem, permitir admin123 como padrão
                        console.log('Nenhuma senha salva, usando padrão admin123');
                        isValidPassword = password === 'admin123';
                        if (isValidPassword) {
                            localStorage.setItem('adminPassword', simpleHash('admin123'));
                        }
                    }
                }
                
                if (isValidPassword) {
                    isAdmin = true;
                    document.getElementById('admin-login').classList.add('hidden');
                    document.getElementById('admin-panel').classList.remove('hidden');
                    showAdminTab('manage-games');
                    await loadAllData();
                    errorDiv.classList.add('hidden');
                } else {
                    errorDiv.textContent = 'Senha incorreta! Tente "admin123"';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Erro no login:', error);
                errorDiv.textContent = 'Erro ao fazer login: ' + error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        // Logout do admin
        function adminLogout() {
            isAdmin = false;
            document.getElementById('admin-password').value = '';
            document.getElementById('admin-login').classList.remove('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('login-error').classList.add('hidden');
            showSection('jogos');
        }

        // Mostrar aba do admin
        function showAdminTab(tabId) {
            // Remover active de todas as abas
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active', 'border-blue-600', 'text-blue-600');
                tab.classList.add('text-gray-600');
            });

            // Adicionar active à aba selecionada
            const activeTab = document.querySelector(`.admin-tab[onclick="showAdminTab('${tabId}')"]`);
            activeTab.classList.add('active', 'border-b-2', 'border-blue-600', 'text-blue-600');
            activeTab.classList.remove('text-gray-600');

            // Esconder todos os conteúdos
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Mostrar conteúdo da aba selecionada
            document.getElementById(tabId).classList.remove('hidden');

            // Limpar mensagens de erro/sucesso
            if (document.getElementById('password-error')) {
                document.getElementById('password-error').classList.add('hidden');
            }
            if (document.getElementById('password-success')) {
                document.getElementById('password-success').classList.add('hidden');
            }

            // Atualizar listas se necessário
            if (tabId === 'manage-games') {
                renderAdminGamesList();
            } else if (tabId === 'manage-participants') {
                renderParticipantsList();
            } else if (tabId === 'manage-guesses') {
                updateGuessDropdowns();
                renderGuessesList();
            }
        }

        // Mostrar formulário de jogo
        function showGameForm() {
            document.getElementById('game-form').classList.remove('hidden');
            // Limpar formulário
            document.getElementById('game-round').value = currentRound;

            // Definir data padrão (amanhã às 20:00)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(20, 0, 0, 0);
            document.getElementById('game-date').value = tomorrow.toISOString().slice(0, 16);

            document.getElementById('home-team').value = '';
            document.getElementById('away-team').value = '';
            document.getElementById('game-stadium').value = 'Albertão';
        }

        // Esconder formulário de jogo
        function hideGameForm() {
            document.getElementById('game-form').classList.add('hidden');
        }

        // Salvar jogo
        async function saveGame() {
            const round = parseInt(document.getElementById('game-round').value);
            const date = document.getElementById('game-date').value;
            const homeTeam = document.getElementById('home-team').value.trim();
            const awayTeam = document.getElementById('away-team').value.trim();
            const stadium = document.getElementById('game-stadium').value.trim();

            if (!homeTeam || !awayTeam || !stadium || !date) {
                alert('Preencha todos os campos!');
                return;
            }

            if (isNaN(round) || round < 1) {
                alert('Rodada inválida!');
                return;
            }

            try {
                await db.collection('games').add({
                    round: round,
                    date: new Date(date),
                    homeTeam: homeTeam,
                    awayTeam: awayTeam,
                    stadium: stadium,
                    officialScore: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('Jogo salvo com sucesso!');
                hideGameForm();
                await loadGames();
                renderGames();
                updateRoundsFilter();
                renderAdminGamesList();
            } catch (error) {
                console.error('Erro ao salvar jogo:', error);
                alert('Erro ao salvar jogo: ' + error.message);
            }
        }

        // Renderizar lista de jogos no admin
        function renderAdminGamesList() {
            const container = document.getElementById('admin-games-list');
            container.innerHTML = '';

            if (games.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum jogo cadastrado</p>';
                return;
            }

            // Ordenar jogos por rodada e data
            const sortedGames = [...games].sort((a, b) => {
                if (a.round !== b.round) return a.round - b.round;
                const dateA = a.date ? (a.date.toDate ? a.date.toDate() : new Date(a.date)) : new Date(0);
                const dateB = b.date ? (b.date.toDate ? b.date.toDate() : new Date(b.date)) : new Date(0);
                return dateA - dateB;
            });

            sortedGames.forEach(game => {
                let dateStr = 'Data não definida';
                if (game.date) {
                    try {
                        const gameDate = game.date.toDate ? game.date.toDate() : new Date(game.date);
                        dateStr = gameDate.toLocaleDateString('pt-BR');
                    } catch (e) {
                        console.error('Erro ao formatar data:', e);
                    }
                }

                const hasOfficialScore = game.officialScore ? true : false;
                const officialScoreHtml = hasOfficialScore ?
                    `<span class="ml-2 px-2 py-1 bg-green-100 text-green-600 rounded text-xs font-bold">
                        ${game.officialScore}
                    </span>` :
                    '<span class="ml-2 px-2 py-1 bg-yellow-100 text-yellow-600 rounded text-xs font-bold">Aguardando</span>';

                const gameElement = document.createElement('div');
                gameElement.className = 'flex justify-between items-center p-4 border-b hover:bg-gray-50';
                gameElement.innerHTML = `
                    <div class="flex-1">
                        <div class="font-bold text-lg">${game.homeTeam} vs ${game.awayTeam}</div>
                        <div class="text-sm text-gray-600">
                            <span class="inline-block px-2 py-1 bg-blue-100 text-blue-600 rounded text-xs font-medium mr-2">
                                Rodada ${game.round}
                            </span>
                            ${dateStr} • ${game.stadium || 'Estádio não definido'}
                            ${officialScoreHtml}
                        </div>
                    </div>
                    <div class="flex space-x-2 ml-4">
                        <button onclick="editGame('${game.id}')" 
                                class="px-3 py-1 bg-blue-100 text-blue-600 rounded hover:bg-blue-200 text-sm">
                            <i class="fas fa-edit mr-1"></i>Editar
                        </button>
                        <button onclick="deleteGame('${game.id}')" 
                                class="px-3 py-1 bg-red-100 text-red-600 rounded hover:bg-red-200 text-sm">
                            <i class="fas fa-trash mr-1"></i>Excluir
                        </button>
                    </div>
                `;
                container.appendChild(gameElement);
            });
        }

        // Editar jogo
        async function editGame(gameId) {
            const game = games.find(g => g.id === gameId);
            if (!game) return;

            // Preencher formulário com dados do jogo
            document.getElementById('game-round').value = game.round;
            document.getElementById('home-team').value = game.homeTeam;
            document.getElementById('away-team').value = game.awayTeam;
            document.getElementById('game-stadium').value = game.stadium;

            // Formatar data para o input datetime-local
            let formattedDate = '';
            if (game.date) {
                try {
                    const gameDate = game.date.toDate ? game.date.toDate() : new Date(game.date);
                    formattedDate = gameDate.toISOString().slice(0, 16);
                } catch (e) {
                    formattedDate = new Date().toISOString().slice(0, 16);
                }
            } else {
                formattedDate = new Date().toISOString().slice(0, 16);
            }
            document.getElementById('game-date').value = formattedDate;

            // Alterar botão para atualizar
            const saveButton = document.querySelector('#game-form button[onclick="saveGame()"]');
            saveButton.innerHTML = '<i class="fas fa-save mr-2"></i>Atualizar Jogo';
            saveButton.onclick = function () {
                updateGame(gameId);
            };

            document.getElementById('game-form').classList.remove('hidden');
        }

        // Atualizar jogo
        async function updateGame(gameId) {
            const round = parseInt(document.getElementById('game-round').value);
            const date = document.getElementById('game-date').value;
            const homeTeam = document.getElementById('home-team').value.trim();
            const awayTeam = document.getElementById('away-team').value.trim();
            const stadium = document.getElementById('game-stadium').value.trim();

            if (!homeTeam || !awayTeam || !stadium || !date) {
                alert('Preencha todos os campos!');
                return;
            }

            if (isNaN(round) || round < 1) {
                alert('Rodada inválida!');
                return;
            }

            try {
                await db.collection('games').doc(gameId).update({
                    round: round,
                    date: new Date(date),
                    homeTeam: homeTeam,
                    awayTeam: awayTeam,
                    stadium: stadium,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('Jogo atualizado com sucesso!');
                hideGameForm();
                await loadGames();
                renderGames();
                renderAdminGamesList();

                // Resetar botão
                const saveButton = document.querySelector('#game-form button[onclick="updateGame()"]');
                if (saveButton) {
                    saveButton.innerHTML = '<i class="fas fa-save mr-2"></i>Salvar Jogo';
                    saveButton.onclick = saveGame;
                }
            } catch (error) {
                console.error('Erro ao atualizar jogo:', error);
                alert('Erro ao atualizar jogo: ' + error.message);
            }
        }

        // Excluir jogo
        async function deleteGame(gameId) {
            if (!confirm(
                'Tem certeza que deseja excluir este jogo? Todos os palpites relacionados serão perdidos.')) {
                return;
            }

            try {
                // Excluir palpites relacionados
                const gameGuesses = guesses.filter(g => g.gameId === gameId);
                const deletePromises = gameGuesses.map(guess =>
                    db.collection('guesses').doc(guess.id).delete()
                );
                await Promise.all(deletePromises);

                // Excluir jogo
                await db.collection('games').doc(gameId).delete();

                alert('Jogo excluído com sucesso!');
                await loadAllData();
            } catch (error) {
                console.error('Erro ao excluir jogo:', error);
                alert('Erro ao excluir jogo: ' + error.message);
            }
        }

        // Adicionar participante
        async function addParticipant() {
            const nameInput = document.getElementById('new-participant');
            const name = nameInput.value.trim();

            if (!name) {
                alert('Digite o nome do participante!');
                return;
            }

            if (participants.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                alert('Este participante já está cadastrado!');
                return;
            }

            try {
                await db.collection('participants').add({
                    name: name,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                nameInput.value = '';
                alert('Participante adicionado com sucesso!');
                await loadParticipants();
                calculateRanking();
                renderParticipantsList();
            } catch (error) {
                console.error('Erro ao adicionar participante:', error);
                alert('Erro ao adicionar participante: ' + error.message);
            }
        }

        // Renderizar lista de participantes
        function renderParticipantsList() {
            const container = document.getElementById('participants-list');
            container.innerHTML = '';

            if (participants.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum participante cadastrado</p>';
                return;
            }

            // Ordenar participantes por nome
            const sortedParticipants = [...participants].sort((a, b) =>
                a.name.localeCompare(b.name)
            );

            sortedParticipants.forEach(participant => {
                const participantGuesses = guesses.filter(g => g.participantId === participant.id).length;
                const participantPoints = ranking.find(r => r.id === participant.id)?.points || 0;

                const participantElement = document.createElement('div');
                participantElement.className =
                'flex justify-between items-center p-3 border-b hover:bg-gray-50';
                participantElement.innerHTML = `
                    <div class="flex-1">
                        <div class="font-medium">${participant.name}</div>
                        <div class="text-sm text-gray-600">
                            ${participantGuesses} palpites • ${participantPoints} pontos
                        </div>
                    </div>
                    <button onclick="deleteParticipant('${participant.id}')" 
                            class="ml-4 text-red-500 hover:text-red-700 p-2">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                container.appendChild(participantElement);
            });
        }

        // Excluir participante
        async function deleteParticipant(participantId) {
            if (!confirm(
                'Tem certeza que deseja excluir este participante? Todos os palpites dele serão perdidos.')) {
                return;
            }

            try {
                // Excluir palpites do participante
                const participantGuesses = guesses.filter(g => g.participantId === participantId);
                const deletePromises = participantGuesses.map(guess =>
                    db.collection('guesses').doc(guess.id).delete()
                );
                await Promise.all(deletePromises);

                // Excluir participante
                await db.collection('participants').doc(participantId).delete();

                alert('Participante excluído com sucesso!');
                await loadAllData();
            } catch (error) {
                console.error('Erro ao excluir participante:', error);
                alert('Erro ao excluir participante: ' + error.message);
            }
        }

        // Atualizar dropdowns de palpites
        function updateGuessDropdowns() {
            const gameSelect = document.getElementById('guess-game');
            const participantSelect = document.getElementById('guess-participant');

            // Limpar opções
            gameSelect.innerHTML = '<option value="">Selecione um jogo</option>';
            participantSelect.innerHTML = '<option value="">Selecione um participante</option>';

            // Adicionar jogos sem placar oficial
            const gamesWithoutScore = games.filter(game => !game.officialScore);

            if (gamesWithoutScore.length === 0) {
                gameSelect.innerHTML = '<option value="">Nenhum jogo disponível para palpite</option>';
            } else {
                gamesWithoutScore.forEach(game => {
                    const option = document.createElement('option');
                    option.value = game.id;
                    option.textContent = `${game.homeTeam} vs ${game.awayTeam} (Rodada ${game.round})`;
                    gameSelect.appendChild(option);
                });
            }

            // Adicionar participantes
            if (participants.length === 0) {
                participantSelect.innerHTML = '<option value="">Nenhum participante cadastrado</option>';
            } else {
                participants.forEach(participant => {
                    const option = document.createElement('option');
                    option.value = participant.id;
                    option.textContent = participant.name;
                    participantSelect.appendChild(option);
                });
            }
        }

        // Adicionar palpite
        async function addGuess() {
            const gameId = document.getElementById('guess-game').value;
            const participantId = document.getElementById('guess-participant').value;
            const score = document.getElementById('guess-score').value.trim();

            if (!gameId || !participantId || !score) {
                alert('Preencha todos os campos!');
                return;
            }

            // Validar formato do placar
            if (!/^\d+x\d+$/.test(score)) {
                alert('Formato inválido! Use o formato: 2x1 (números separados por "x")');
                return;
            }

            try {
                // Verificar se já existe palpite para este jogo e participante
                const existingGuess = guesses.find(g =>
                    g.gameId === gameId && g.participantId === participantId);

                if (existingGuess) {
                    if (!confirm('Este participante já tem um palpite para este jogo. Deseja substituir?')) {
                        return;
                    }
                    await db.collection('guesses').doc(existingGuess.id).delete();
                }

                await db.collection('guesses').add({
                    gameId: gameId,
                    participantId: participantId,
                    score: score,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                document.getElementById('guess-score').value = '';
                alert('Palpite adicionado com sucesso!');
                await loadGuesses();
                renderGuessesList();
                renderGames();
                calculateRanking();
            } catch (error) {
                console.error('Erro ao adicionar palpite:', error);
                alert('Erro ao adicionar palpite: ' + error.message);
            }
        }

        // Renderizar lista de palpites
        function renderGuessesList() {
            const container = document.getElementById('guesses-list');
            container.innerHTML = '';

            if (guesses.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum palpite registrado</p>';
                return;
            }

            // Agrupar palpites por jogo
            const guessesByGame = {};
            guesses.forEach(guess => {
                if (!guessesByGame[guess.gameId]) {
                    guessesByGame[guess.gameId] = [];
                }
                guessesByGame[guess.gameId].push(guess);
            });

            for (const gameId in guessesByGame) {
                const game = games.find(g => g.id === gameId);
                if (!game) continue;

                const gameGuesses = guessesByGame[gameId];
                const hasOfficialScore = game.officialScore ? true : false;

                let gameElement = document.createElement('div');
                gameElement.className = 'mb-6 border rounded-lg overflow-hidden shadow-sm';

                let gameHtml = `
                    <div class="bg-gray-100 p-3 font-bold border-b">
                        <div class="flex justify-between items-center">
                            <span>${game.homeTeam} vs ${game.awayTeam}</span>
                            <span class="text-sm font-normal bg-blue-100 text-blue-600 px-2 py-1 rounded">
                                Rodada ${game.round}
                            </span>
                        </div>
                        <div class="text-sm font-normal text-gray-600 mt-1">
                            ${game.stadium} • ${hasOfficialScore ? `Placar: ${game.officialScore}` : 'Aguardando placar'}
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="space-y-2">
                `;

                gameGuesses.forEach(guess => {
                    const participant = participants.find(p => p.id === guess.participantId);
                    const points = hasOfficialScore ? calculateGuessPoints(game, guess) : 0;

                    let pointsHtml = '';
                    if (points > 0) {
                        pointsHtml = `<span class="px-2 py-1 bg-green-100 text-green-600 rounded text-sm font-bold">
                            ${points} ponto${points !== 1 ? 's' : ''}
                        </span>`;
                    } else if (hasOfficialScore) {
                        pointsHtml = `<span class="px-2 py-1 bg-red-100 text-red-600 rounded text-sm font-bold">
                            0 pontos
                        </span>`;
                    }

                    gameHtml += `
                            <div class="flex justify-between items-center p-2 border-b last:border-0 hover:bg-gray-50">
                                <div class="flex-1">
                                    <div class="font-medium">${participant ? participant.name : 'Desconhecido'}</div>
                                    <div class="text-sm text-gray-600">Palpite: <span class="font-bold">${guess.score}</span></div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    ${pointsHtml}
                                    <button onclick="deleteGuess('${guess.id}')" 
                                            class="text-red-500 hover:text-red-700 p-1">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                    `;
                });

                gameHtml += `
                        </div>
                    </div>
                `;

                gameElement.innerHTML = gameHtml;
                container.appendChild(gameElement);
            }
        }

        // Excluir palpite
        async function deleteGuess(guessId) {
            if (!confirm('Tem certeza que deseja excluir este palpite?')) {
                return;
            }

            try {
                await db.collection('guesses').doc(guessId).delete();
                alert('Palpite excluído com sucesso!');
                await loadGuesses();
                renderGuessesList();
                calculateRanking();
                renderGames();
            } catch (error) {
                console.error('Erro ao excluir palpite:', error);
                alert('Erro ao excluir palpite: ' + error.message);
            }
        }

        // Mostrar modal de placar oficial
        function showScoreModal(gameId) {
            currentGameId = gameId;
            const game = games.find(g => g.id === gameId);

            if (!game) return;

            document.getElementById('modal-game-info').textContent =
                `Rodada ${game.round} - ${game.stadium}`;
            document.getElementById('modal-home-team').textContent = game.homeTeam;
            document.getElementById('modal-away-team').textContent = game.awayTeam;

            // Preencher placar atual se existir
            if (game.officialScore) {
                const [homeScore, awayScore] = game.officialScore.split('x');
                document.getElementById('official-home-score').value = homeScore;
                document.getElementById('official-away-score').value = awayScore;
            } else {
                document.getElementById('official-home-score').value = '0';
                document.getElementById('official-away-score').value = '0';
            }

            document.getElementById('score-modal').classList.remove('hidden');
        }

        // Esconder modal de placar
        function hideScoreModal() {
            document.getElementById('score-modal').classList.add('hidden');
        }

        // Salvar placar oficial
        async function saveOfficialScore() {
            const homeScore = parseInt(document.getElementById('official-home-score').value);
            const awayScore = parseInt(document.getElementById('official-away-score').value);

            if (isNaN(homeScore) || isNaN(awayScore)) {
                alert('Digite placares válidos!');
                return;
            }

            if (homeScore < 0 || awayScore < 0) {
                alert('Os placares não podem ser negativos!');
                return;
            }

            const officialScore = `${homeScore}x${awayScore}`;

            try {
                await db.collection('games').doc(currentGameId).update({
                    officialScore: officialScore,
                    scoreUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert('Placar oficial salvo com sucesso! Os pontos serão calculados automaticamente.');
                hideScoreModal();
                await loadGames();
                await loadGuesses();
                calculateRanking();
                renderGames();
            } catch (error) {
                console.error('Erro ao salvar placar:', error);
                alert('Erro ao salvar placar: ' + error.message);
            }
        }

        // Alterar senha do admin - SISTEMA SIMPLIFICADO E FUNCIONAL
        async function changeAdminPassword() {
            const currentPass = document.getElementById('current-password').value;
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-password').value;

            const errorDiv = document.getElementById('password-error');
            const successDiv = document.getElementById('password-success');

            // Limpar mensagens
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');

            if (!currentPass || !newPass || !confirmPass) {
                errorDiv.textContent = 'Preencha todos os campos!';
                errorDiv.classList.remove('hidden');
                return;
            }

            if (newPass !== confirmPass) {
                errorDiv.textContent = 'As novas senhas não coincidem!';
                errorDiv.classList.remove('hidden');
                return;
            }

            if (newPass.length < 4) {
                errorDiv.textContent = 'A nova senha deve ter pelo menos 4 caracteres!';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                // Verificar senha atual
                const currentHash = simpleHash(currentPass);
                const adminRef = db.collection('admin').doc('password');
                const doc = await adminRef.get();

                if (!doc.exists) {
                    // Se não existir, criar com a nova senha
                    const newHash = simpleHash(newPass);
                    await adminRef.set({
                        password: newHash,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    successDiv.textContent = 'Senha criada com sucesso!';
                    successDiv.classList.remove('hidden');

                    // Limpar campos
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';

                    return;
                }

                const storedHash = doc.data().password;

                console.log('Hash da senha atual digitada:', currentHash);
                console.log('Hash armazenado:', storedHash);

                if (storedHash !== currentHash) {
                    errorDiv.textContent = 'Senha atual incorreta!';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                // Atualizar senha
                const newHash = simpleHash(newPass);

                await adminRef.update({
                    password: newHash,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Limpar campos
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';

                successDiv.textContent = 'Senha alterada com sucesso!';
                successDiv.classList.remove('hidden');

                // Verificar se foi atualizada
                setTimeout(async () => {
                    const updatedDoc = await adminRef.get();
                    if (simpleHash(newPass) === updatedDoc.data().password) {
                        console.log('Senha atualizada com sucesso no Firestore!');
                    }
                }, 1000);

            } catch (error) {
                console.error('Erro ao alterar senha:', error);
                errorDiv.textContent = 'Erro ao alterar senha: ' + error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        // Atualizar listas no admin
        function updateAdminLists() {
            if (isAdmin) {
                renderAdminGamesList();
                renderParticipantsList();
                updateGuessDropdowns();
                renderGuessesList();
            }
        }

        // Mostrar formulário de palpite para um jogo específico
        function showGuessForm(gameId) {
            // Selecionar o jogo automaticamente
            const gameSelect = document.getElementById('guess-game');
            gameSelect.value = gameId;

            // Mostrar aba de palpites
            showAdminTab('manage-guesses');

            // Rolar até o formulário
            setTimeout(() => {
                document.getElementById('guess-game').scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 100);
        }

        // Função para testar login
        window.testLogin = async function () {
            console.log('Testando login com senha "admin123"...');
            const hash = simpleHash('admin123');
            console.log('Hash de "admin123":', hash);

            const adminRef = db.collection('admin').doc('password');
            const doc = await adminRef.get();

            if (doc.exists) {
                console.log('Hash armazenado:', doc.data().password);
                console.log('São iguais?', hash === doc.data().password);
            } else {
                console.log('Documento admin não existe!');
            }
        };
    </script>
</body>

</html>