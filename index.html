<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bolão Piauizão - Campeonato Piauiense</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        :root {
            --pi-green: #008248;
            --pi-yellow: #ffed00;
            --pi-blue: #003da5;
        }

        body {
            background-color: #f3f4f6;
            font-family: 'Inter', sans-serif;
        }

        .bg-piaui-green {
            background-color: var(--pi-green);
        }

        .text-piaui-green {
            color: var(--pi-green);
        }

        .bg-piaui-yellow {
            background-color: var(--pi-yellow);
        }

        .border-piaui-blue {
            border-color: var(--pi-blue);
        }

        .card-match {
            transition: transform 0.2s;
        }

        .card-match:hover {
            transform: translateY(-2px);
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--pi-green);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        /* Estilo para impressão do PDF */
        @media print {

            header,
            nav,
            button,
            #auth-box,
            .no-print {
                display: none !important;
            }

            body {
                background: white;
                padding: 0;
            }

            .view-content {
                display: block !important;
            }

            .shadow-xl {
                box-shadow: none !important;
                border: 1px solid #ddd;
            }
        }

        /* Garantir que o botão do menu seja clicável em mobile */
        .mobile-menu-btn {
            cursor: pointer;
            z-index: 50;
            padding: 10px;
            margin: -10px;
        }
    </style>
</head>

<body class="pb-12">

    <!-- Header -->
    <header class="bg-piaui-green text-white shadow-lg no-print sticky top-0 z-50">
        <div class="container mx-auto px-4 py-6 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-white p-2 rounded-full">
                    <i class="fas fa-futbol text-piaui-green text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold tracking-tight">Bolão <span class="text-piaui-yellow">Piauizão</span></h1>
            </div>
            <nav id="main-nav" class="hidden md:flex space-x-6 font-medium">
                <a href="#" onclick="switchView('home')" class="hover:text-piaui-yellow">Início</a>
                <a href="#" onclick="switchView('ranking')" class="hover:text-piaui-yellow">Ranking</a>
                <a href="#" onclick="toggleAdminLogin()" class="opacity-50 hover:opacity-100"><i
                        class="fas fa-lock"></i></a>
            </nav>
            <!-- Botão do Menu Mobile -->
            <button class="md:hidden text-2xl mobile-menu-btn" onclick="toggleMenu()" aria-label="Abrir Menu">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div id="mobile-menu"
        class="hidden bg-piaui-green text-white px-4 py-4 space-y-4 border-t border-green-700 no-print sticky top-[76px] z-40 shadow-xl">
        <a href="#" onclick="switchView('home')" class="block py-3 border-b border-green-700 font-bold">Início</a>
        <a href="#" onclick="switchView('ranking')" class="block py-3 border-b border-green-700 font-bold">Ranking</a>
        <a href="#" onclick="toggleAdminLogin()" class="block py-3 text-yellow-300 font-bold">Acesso Admin</a>
    </div>

    <main class="container mx-auto px-4 mt-8">

        <!-- VIEW: HOME -->
        <section id="view-home" class="view-content">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">Jogos da Rodada</h2>
                    <p class="text-gray-600">Confira as partidas e seus palpites registrados!</p>
                </div>
                <!-- Info do Usuário com botão de Sair -->
                <div id="user-info"
                    class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-piaui-blue hidden min-w-[200px]">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Acessando como:</p>
                            <p class="font-bold text-piaui-blue" id="display-user-name"></p>
                        </div>
                        <button onclick="logoutPlayer()"
                            class="text-xs text-red-500 font-black hover:text-red-700 transition ml-4 bg-red-50 px-3 py-1 rounded-full uppercase">
                            <i class="fas fa-sign-out-alt mr-1"></i>Sair
                        </button>
                    </div>
                </div>
            </div>

            <!-- Identificação rápida -->
            <div id="auth-box" class="bg-white p-6 rounded-2xl shadow-md mb-8 max-w-md mx-auto no-print">
                <h3 class="text-lg font-bold mb-4 text-center">Digite seu nome para palpar</h3>
                <div class="flex space-x-2">
                    <input type="text" id="input-player-name" placeholder="Seu nome completo"
                        class="flex-1 border rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 outline-none">
                    <button onclick="setPlayerName()"
                        class="bg-piaui-green text-white px-6 py-2 rounded-lg font-bold hover:bg-opacity-90 transition">Entrar</button>
                </div>
            </div>

            <div id="matches-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="col-span-full flex flex-col items-center justify-center py-12">
                    <div class="loader mb-4"></div>
                    <p class="text-gray-500 font-medium">Conectando ao sistema...</p>
                </div>
            </div>
        </section>

        <!-- VIEW: RANKING -->
        <section id="view-ranking" class="view-content hidden">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800">Classificação Geral</h2>
                <button onclick="exportRankingPDF()"
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 no-print">
                    <i class="fas fa-file-pdf mr-2"></i>Exportar PDF
                </button>
            </div>

            <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-6 py-4 font-bold text-gray-700">Pos</th>
                            <th class="px-6 py-4 font-bold text-gray-700">Participante</th>
                            <th class="px-6 py-4 font-bold text-gray-700 text-center">Palpites</th>
                            <th class="px-6 py-4 font-bold text-gray-700 text-right">Pontos</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-table-body"></tbody>
                </table>
            </div>
        </section>

        <!-- VIEW: ADMIN -->
        <section id="view-admin" class="view-content hidden">
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <h2 class="text-3xl font-bold text-red-600"><i class="fas fa-tools mr-2"></i>Painel Admin</h2>
                <div class="flex space-x-2">
                    <button onclick="openMatchModal()"
                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                        <i class="fas fa-plus mr-2"></i>Novo Jogo
                    </button>
                    <button onclick="logoutAdmin()"
                        class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Sair</button>
                </div>
            </div>
            <div class="grid grid-cols-1 gap-4" id="admin-matches-list"></div>
        </section>
    </main>

    <!-- Modal: Palpite Individual -->
    <div id="modal-bet" class="modal no-print">
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full mx-4 shadow-2xl">
            <h3 class="text-xl font-bold mb-6 text-center" id="modal-bet-title">Seu Palpite</h3>
            <div class="flex items-center justify-between mb-8 space-x-4">
                <div class="text-center flex-1">
                    <p class="font-bold text-sm mb-2 truncate" id="home-team-name"></p>
                    <input type="number" id="bet-home"
                        class="w-16 h-16 text-2xl text-center border-2 border-gray-200 rounded-xl focus:border-piaui-green outline-none"
                        min="0" value="0">
                </div>
                <div class="text-2xl font-bold text-gray-400">X</div>
                <div class="text-center flex-1">
                    <p class="font-bold text-sm mb-2 truncate" id="away-team-name"></p>
                    <input type="number" id="bet-away"
                        class="w-16 h-16 text-2xl text-center border-2 border-gray-200 rounded-xl focus:border-piaui-green outline-none"
                        min="0" value="0">
                </div>
            </div>
            <div class="flex flex-col space-y-3">
                <button onclick="saveBet()"
                    class="bg-piaui-green text-white py-3 rounded-xl font-bold hover:bg-opacity-90">Salvar
                    Palpite</button>
                <button onclick="closeModal('modal-bet')" class="text-gray-500 py-2">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Login Admin -->
    <div id="modal-admin-login" class="modal no-print">
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full mx-4 shadow-2xl">
            <h3 class="text-xl font-bold mb-6 text-center">Acesso Restrito</h3>
            <input type="password" id="admin-pass" placeholder="Senha do Admin"
                class="w-full border rounded-lg px-4 py-3 mb-4 focus:ring-2 focus:ring-red-500 outline-none">
            <button onclick="loginAdmin()"
                class="w-full bg-red-600 text-white py-3 rounded-xl font-bold hover:bg-red-700">Entrar</button>
            <button onclick="closeModal('modal-admin-login')" class="w-full text-gray-500 py-2 mt-2">Fechar</button>
        </div>
    </div>

    <!-- Modal: Cadastro/Edição de Jogo + Importação em Massa -->
    <div id="modal-match-admin" class="modal no-print">
        <div class="bg-white rounded-2xl p-8 max-w-2xl w-full mx-4 shadow-2xl overflow-y-auto max-h-[95vh]">
            <h3 class="text-xl font-bold mb-6 text-center" id="match-admin-title">Configurar Jogo</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Rodada</label>
                            <input type="text" id="admin-match-round" placeholder="01/07"
                                class="w-full border rounded px-3 py-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Data/Hora</label>
                            <input type="text" id="admin-match-date" placeholder="10/01 16:00"
                                class="w-full border rounded px-3 py-2 text-sm">
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Estádio</label>
                        <input type="text" id="admin-match-stadium" placeholder="Estádio..."
                            class="w-full border rounded px-3 py-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Time Mandante</label>
                        <input type="text" id="admin-home-team"
                            class="w-full border rounded px-3 py-2 text-sm font-bold">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Time Visitante</label>
                        <input type="text" id="admin-away-team"
                            class="w-full border rounded px-3 py-2 text-sm font-bold">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Placar Real
                                (Casa)</label>
                            <input type="number" id="admin-home-score"
                                class="w-full border rounded px-3 py-2 text-lg font-black" value="0">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Placar Real
                                (Fora)</label>
                            <input type="number" id="admin-away-score"
                                class="w-full border rounded px-3 py-2 text-lg font-black" value="0">
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 bg-yellow-50 p-2 rounded border border-yellow-100">
                        <input type="checkbox" id="admin-is-finished" class="w-4 h-4">
                        <span class="text-xs font-bold text-yellow-800 uppercase">Finalizar e Calcular Pontos</span>
                    </div>
                    <div class="pt-2 flex flex-col space-y-2">
                        <button onclick="saveMatchAdmin()"
                            class="bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition">Salvar
                            Jogo</button>
                        <button onclick="deleteMatchAdmin()" id="btn-delete-match"
                            class="hidden text-red-500 text-xs py-1">Excluir Jogo</button>
                    </div>
                </div>

                <!-- Coluna: Importação em Massa -->
                <div class="border-l pl-0 md:pl-8 space-y-4">
                    <label class="block text-[10px] font-bold text-gray-500 uppercase">Importar Palpites (Cole
                        Aqui)</label>
                    <p class="text-[9px] text-gray-400 italic mb-2">Formato: 0X1 Nome do Participante</p>
                    <textarea id="bulk-bets-input" rows="10"
                        class="w-full border rounded p-3 text-xs font-mono bg-gray-50"
                        placeholder="0X1 Yan Gabriel&#10;1X3 Hudson"></textarea>
                    <button onclick="processBulkImport()"
                        class="w-full bg-piaui-green text-white py-2 rounded-lg font-bold text-xs hover:bg-opacity-90">Adicionar
                        à Base</button>
                </div>
            </div>
            <button onclick="closeModal('modal-match-admin')" class="w-full text-gray-400 text-xs mt-6">Fechar</button>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast"
        class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl hidden z-[200]">
        <span id="toast-msg">Mensagem</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAdlBq3u0C5npsi_pB-CYxPJxxlIj1ucYg",
            authDomain: "bolaopiauizao.firebaseapp.com",
            projectId: "bolaopiauizao",
            storageBucket: "bolaopiauizao.firebasestorage.app",
            messagingSenderId: "126657670519",
            appId: "1:126657670519:web:12c310049e4bc69ef84572",
            measurementId: "G-MKSKR9SL5R"
        };
        
        const appId = 'bolao-piauizao-oficial';
        const matchesList = document.getElementById('matches-list');

        let auth, db, appInstance;
        let currentUser = null;
        let isAdmin = false;
        let matches = [];
        let userGuesses = [];
        let activeMatchId = null;
        let playerName = localStorage.getItem('bolao_user_name') || "";
        let unsubs = [];

        async function init() {
            try {
                appInstance = initializeApp(firebaseConfig);
                auth = getAuth(appInstance);
                db = getFirestore(appInstance);

                // RULE 3: Auth first
                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    if (user) {
                        startListeners();
                        if (playerName) setPlayerUI();
                    }
                });
            } catch (err) {
                console.error("Firebase Error:", err);
                if (matchesList) matchesList.innerHTML = `<div class='col-span-full text-center py-12 text-red-500'>Erro de ligação: ${err.message}</div>`;
            }
        }

        function startListeners() {
            if (!currentUser) return;
            unsubs.forEach(u => u());
            unsubs = [];

            // RULE 1: Strict paths
            const qMatches = collection(db, 'artifacts', appId, 'public', 'data', 'matches');
            const unsubMatches = onSnapshot(qMatches, (snapshot) => {
                matches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMatches();
                renderAdminMatches();
                calculateRanking(); // Recalcula quando os jogos mudam (ex: exclusão)
            });
            unsubs.push(unsubMatches);

            const qGuesses = collection(db, 'artifacts', appId, 'public', 'data', 'guesses');
            const unsubGuesses = onSnapshot(qGuesses, (snapshot) => {
                userGuesses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMatches();
                calculateRanking();
            });
            unsubs.push(unsubGuesses);
        }

        // --- RENDERIZAÇÃO ---
        window.setPlayerName = () => {
            const nameInput = document.getElementById('input-player-name').value.trim();
            if (!nameInput) return showToast("Digite o seu nome!");
            playerName = nameInput;
            localStorage.setItem('bolao_user_name', playerName);
            setPlayerUI();
        };

        window.logoutPlayer = () => {
            playerName = "";
            localStorage.removeItem('bolao_user_name');
            const ab = document.getElementById('auth-box');
            const ui = document.getElementById('user-info');
            if (ab) ab.classList.remove('hidden');
            if (ui) ui.classList.add('hidden');
            document.getElementById('input-player-name').value = "";
            renderMatches();
            showToast("Sessão encerrada.");
        };

        function setPlayerUI() {
            const ab = document.getElementById('auth-box');
            const ui = document.getElementById('user-info');
            if (ab) ab.classList.add('hidden');
            if (ui) ui.classList.remove('hidden');
            const dn = document.getElementById('display-user-name');
            if (dn) dn.innerText = playerName;
            renderMatches();
        }

        function renderMatches() {
            if (!matchesList) return;
            if (matches.length === 0) {
                matchesList.innerHTML = `<div class='col-span-full text-center py-12'>Sem jogos registados.</div>`;
                return;
            }

            const sorted = [...matches].sort((a, b) => (a.round + a.date).localeCompare(b.round + b.date));
            matchesList.innerHTML = sorted.map(match => {
                const isFinished = match.status === 'finished';
                const matchBets = userGuesses.filter(g => g.matchId === match.id);
                const myBet = matchBets.find(g => g.userName === playerName);

                return `
                    <div class="card-match bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b flex justify-between items-center">
                            <span class="text-[10px] font-black text-piaui-green uppercase">Rodada ${match.round}</span>
                            <span class="text-[9px] ${isFinished ? 'text-gray-400' : 'text-green-600'} font-bold uppercase">${isFinished ? 'Encerrado' : 'Aberto'}</span>
                        </div>
                        <div class="p-6">
                            <div class="text-center mb-3">
                                <p class="text-[9px] text-gray-400 font-bold uppercase">${match.stadium}</p>
                                <p class="text-[10px] text-gray-600">${match.date}</p>
                            </div>
                            <div class="flex items-center justify-between mb-4">
                                <div class="text-center flex-1">
                                    <p class="text-xs font-bold truncate">${match.homeTeam}</p>
                                </div>
                                <div class="px-4 font-black text-xl text-piaui-green">
                                    ${isFinished ? `${match.homeScore} x ${match.awayScore}` : 'VS'}
                                </div>
                                <div class="text-center flex-1">
                                    <p class="text-xs font-bold truncate">${match.awayTeam}</p>
                                </div>
                            </div>
                            
                            <div class="mt-4 pt-4 border-t border-dashed">
                                ${myBet ? `
                                    <div class="bg-piaui-green bg-opacity-5 p-3 rounded-xl border border-piaui-green border-opacity-10 flex justify-between items-center">
                                        <div>
                                            <p class="text-[8px] text-gray-400 uppercase font-bold">Seu Palpite</p>
                                            <p class="text-lg font-black text-piaui-green">${myBet.homeBet} x ${myBet.awayBet}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-[8px] text-gray-400 uppercase font-bold">Pontos</p>
                                            <p class="text-lg font-black ${myBet.points > 0 ? 'text-blue-600' : 'text-gray-300'}">${isFinished ? myBet.points : '--'}</p>
                                        </div>
                                    </div>
                                ` : `
                                    <button onclick="openBetModal('${match.id}')" ${isFinished ? 'disabled' : ''} class="w-full py-2 bg-piaui-yellow text-piaui-green font-bold rounded-lg text-sm transition ${isFinished ? 'opacity-50 cursor-not-allowed' : 'hover:scale-105 active:scale-95'}">Dar Palpite</button>
                                `}
                                <button onclick="toggleDetails('${match.id}')" class="w-full mt-2 text-[10px] text-gray-400 font-bold hover:text-piaui-green uppercase tracking-wide">Ver palpites (${matchBets.length})</button>
                                <div id="details-${match.id}" class="hidden mt-4 space-y-1 max-h-32 overflow-y-auto">
                                    ${matchBets.map(b => `<div class="flex justify-between text-[10px] border-b pb-1"><span class="truncate pr-2">${b.userName}</span><span class="font-bold">${b.homeBet}x${b.awayBet}</span></div>`).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.toggleDetails = (id) => document.getElementById(`details-${id}`).classList.toggle('hidden');

        // CORREÇÃO NO RANKING: Filtra palpites de jogos excluídos
        function calculateRanking() {
            const userTotals = {};
            const activeMatchIds = new Set(matches.map(m => m.id));

            userGuesses.forEach(guess => {
                // Se o jogo deste palpite não existir mais na lista de jogos atual, ignore-o
                if (!activeMatchIds.has(guess.matchId)) return;

                if (!userTotals[guess.userName]) userTotals[guess.userName] = { name: guess.userName, points: 0, count: 0 };
                userTotals[guess.userName].points += (guess.points || 0);
                userTotals[guess.userName].count += 1;
            });

            const sorted = Object.values(userTotals).sort((a, b) => b.points - a.points || b.count - a.count);
            const rt = document.getElementById('ranking-table-body');
            if (rt) rt.innerHTML = sorted.map((u, i) => `
                <tr class="${u.name === playerName ? 'bg-green-50' : ''} border-b hover:bg-gray-50 transition">
                    <td class="px-6 py-4 font-bold text-gray-600">${i + 1}º</td>
                    <td class="px-6 py-4 font-bold text-gray-800">${u.name}</td>
                    <td class="px-6 py-4 text-center text-gray-400 font-medium">${u.count}</td>
                    <td class="px-6 py-4 text-right font-black text-piaui-green text-xl">${u.points}</td>
                </tr>
            `).join('');
        }

        // --- IMPORTAÇÃO EM MASSA ---
        window.processBulkImport = async () => {
            if (!activeMatchId) return showToast("Salve o jogo primeiro!");
            const input = document.getElementById('bulk-bets-input').value;
            const lines = input.split('\n');
            let count = 0;

            showToast("Processando...");
            const batch = writeBatch(db);

            lines.forEach(line => {
                const matchResult = line.match(/(\d+)\s*X\s*(\d+)\s+(.+)/i);
                if (matchResult) {
                    const homeBet = parseInt(matchResult[1]);
                    const awayBet = parseInt(matchResult[2]);
                    const name = matchResult[3].trim();

                    if (name && !isNaN(homeBet) && !isNaN(awayBet)) {
                        const betRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'guesses'));
                        batch.set(betRef, {
                            matchId: activeMatchId,
                            userName: name,
                            homeBet,
                            awayBet,
                            points: 0,
                            timestamp: Date.now()
                        });
                        count++;
                    }
                }
            });

            if (count > 0) {
                await batch.commit();
                showToast(`${count} palpites importados!`);
                document.getElementById('bulk-bets-input').value = "";
            } else {
                showToast("Nenhum palpite válido encontrado.");
            }
        };

        // --- ADMIN & PONTOS ---
        window.saveMatchAdmin = async () => {
            const isFinished = document.getElementById('admin-is-finished').checked;
            const data = {
                round: document.getElementById('admin-match-round').value,
                date: document.getElementById('admin-match-date').value,
                stadium: document.getElementById('admin-match-stadium').value,
                homeTeam: document.getElementById('admin-home-team').value,
                awayTeam: document.getElementById('admin-away-team').value,
                homeScore: parseInt(document.getElementById('admin-home-score').value) || 0,
                awayScore: parseInt(document.getElementById('admin-away-score').value) || 0,
                status: isFinished ? 'finished' : 'open'
            };

            try {
                let mId = activeMatchId;
                if (activeMatchId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', activeMatchId), data);
                } else {
                    const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'matches'), data);
                    mId = docRef.id;
                    activeMatchId = mId;
                }
                
                if (isFinished) await processPoints(mId, data.homeScore, data.awayScore);
                
                showToast("Jogo guardado com sucesso!");
                if (!isFinished) renderAdminMatches();
            } catch (err) { showToast("Erro ao guardar."); }
        };

        async function processPoints(matchId, realH, realA) {
            const realResult = realH > realA ? 'home' : (realH < realA ? 'away' : 'draw');
            const bets = userGuesses.filter(g => g.matchId === matchId);
            
            const batch = writeBatch(db);
            bets.forEach(b => {
                const betResult = b.homeBet > b.awayBet ? 'home' : (b.homeBet < b.awayBet ? 'away' : 'draw');
                let pts = 0;
                if (betResult === realResult) {
                    pts = (realResult === 'draw') ? 1 : 3;
                }
                batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'guesses', b.id), { points: pts });
            });
            await batch.commit();
        }

        // --- AUXILIARES E MENUS ---
        window.toggleMenu = () => {
            const menu = document.getElementById('mobile-menu');
            if (menu) menu.classList.toggle('hidden');
        };

        window.switchView = (v) => {
            document.querySelectorAll('.view-content').forEach(s => s.classList.add('hidden'));
            const target = document.getElementById(`view-${v}`);
            if (target) target.classList.remove('hidden');
            const menu = document.getElementById('mobile-menu');
            if (menu) menu.classList.add('hidden');
        };

        window.closeModal = (id) => document.getElementById(id).classList.remove('active');
        window.showToast = (m) => {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = m;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        };
        window.openMatchModal = (id = null) => {
            activeMatchId = id;
            const match = matches.find(m => m.id === id);
            const delBtn = document.getElementById('btn-delete-match');
            if (delBtn) delBtn.style.display = id ? 'block' : 'none';
            
            document.getElementById('admin-match-round').value = match?.round || "";
            document.getElementById('admin-match-date').value = match?.date || "";
            document.getElementById('admin-match-stadium').value = match?.stadium || "";
            document.getElementById('admin-home-team').value = match?.homeTeam || "";
            document.getElementById('admin-away-team').value = match?.awayTeam || "";
            document.getElementById('admin-home-score').value = match?.homeScore || 0;
            document.getElementById('admin-away-score').value = match?.awayScore || 0;
            document.getElementById('admin-is-finished').checked = match?.status === 'finished';
            document.getElementById('modal-match-admin').classList.add('active');
        };
        window.toggleAdminLogin = () => isAdmin ? switchView('admin') : document.getElementById('modal-admin-login').classList.add('active');
        window.loginAdmin = () => {
            if (document.getElementById('admin-pass').value === "piaui2024") {
                isAdmin = true; closeModal('modal-admin-login'); switchView('admin');
            } else showToast("Senha incorreta!");
        };
        window.renderAdminMatches = () => {
            const l = document.getElementById('admin-matches-list');
            if (l) l.innerHTML = matches.map(m => `
                <div onclick="openMatchModal('${m.id}')" class="bg-white p-4 rounded-xl border cursor-pointer hover:bg-gray-50 flex justify-between items-center transition">
                    <div>
                        <span class="text-[10px] font-bold text-gray-400 bg-gray-100 px-2 py-0.5 rounded">RODADA ${m.round}</span> 
                        <div class="font-bold mt-1">${m.homeTeam} x ${m.awayTeam}</div>
                    </div>
                    <i class="fas fa-edit text-gray-300"></i>
                </div>
            `).join('');
        };
        window.openBetModal = (id) => {
            if (!playerName) return showToast("Identifique-se primeiro!");
            activeMatchId = id;
            const m = matches.find(x => x.id === id);
            document.getElementById('home-team-name').innerText = m.homeTeam;
            document.getElementById('away-team-name').innerText = m.awayTeam;
            document.getElementById('modal-bet').classList.add('active');
        };
        window.saveBet = async () => {
            const hb = parseInt(document.getElementById('bet-home').value);
            const ab = parseInt(document.getElementById('bet-away').value);
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'guesses'), { matchId: activeMatchId, userName: playerName, homeBet: hb, awayBet: ab, points: 0, timestamp: Date.now() });
            closeModal('modal-bet'); showToast("Palpite guardado!");
        };

        // CORREÇÃO NA EXCLUSÃO: Remove palpites órfãos do banco
        window.deleteMatchAdmin = async () => {
            if (!activeMatchId || !confirm("Deseja eliminar este jogo? Isso removerá permanentemente todos os palpites e pontos vinculados a ele.")) return;
            
            try {
                showToast("Eliminando jogo e palpites...");
                
                // 1. Identificar palpites associados
                const betsToDelete = userGuesses.filter(g => g.matchId === activeMatchId);
                
                // 2. Criar Batch para deletar tudo de uma vez
                const batch = writeBatch(db);
                
                // Adicionar exclusão do jogo
                batch.delete(doc(db, 'artifacts', appId, 'public', 'data', 'matches', activeMatchId));
                
                // Adicionar exclusão de cada palpite
                betsToDelete.forEach(b => {
                    batch.delete(doc(db, 'artifacts', appId, 'public', 'data', 'guesses', b.id));
                });
                
                // Executar
                await batch.commit();
                
                closeModal('modal-match-admin');
                showToast("Jogo e palpites eliminados.");
            } catch (err) {
                console.error(err);
                showToast("Erro ao eliminar jogo.");
            }
        };

        window.exportRankingPDF = () => window.print();

        init();
    </script>
</body>

</html>