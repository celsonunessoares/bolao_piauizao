<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bolão Piauizão - Campeonato Piauiense</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        :root {
            --pi-green: #008248;
            --pi-yellow: #ffed00;
            --pi-blue: #003da5;
        }

        body {
            background-color: #f3f4f6;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            /* Tamanho padrão */
        }

        .bg-piaui-green {
            background-color: var(--pi-green);
        }

        .text-piaui-green {
            color: var(--pi-green);
        }

        .bg-piaui-yellow {
            background-color: var(--pi-yellow);
        }

        .border-piaui-blue {
            border-color: var(--pi-blue);
        }

        .card-match {
            transition: transform 0.2s;
        }

        .card-match:hover {
            transform: translateY(-2px);
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--pi-green);
            border-radius: 50%;
            width: 25px;
            height: 25px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        /* Estilo para impressão do PDF */
        @media print {

            header,
            nav,
            button,
            #auth-box,
            .no-print {
                display: none !important;
            }

            body {
                background: white;
                padding: 0;
            }

            .view-content {
                display: block !important;
            }

            .shadow-xl {
                box-shadow: none !important;
                border: 1px solid #ddd;
            }
        }

        .mobile-menu-btn {
            cursor: pointer;
            z-index: 100;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 10px;
        }
    </style>
</head>

<body class="pb-12">

    <!-- Header -->
    <header class="bg-piaui-green text-white shadow-md no-print sticky top-0 z-[100]">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-white p-1.5 rounded-full">
                    <i class="fas fa-futbol text-piaui-green text-xl"></i>
                </div>
                <h1 class="text-lg md:text-xl font-bold tracking-tight text-white uppercase">Bolão <span
                        class="text-piaui-yellow text-opacity-90">Piauizão</span></h1>
            </div>
            <nav id="main-nav" class="hidden md:flex space-x-5 font-bold text-xs uppercase tracking-wider">
                <a href="#" onclick="switchView('home')" class="hover:text-piaui-yellow transition">Início</a>
                <a href="#" onclick="switchView('ranking')" class="hover:text-piaui-yellow transition">Ranking</a>
                <a href="#" onclick="toggleAdminLogin()" class="opacity-50 hover:opacity-100 transition"><i
                        class="fas fa-lock text-sm"></i></a>
            </nav>
            <button class="md:hidden mobile-menu-btn bg-green-700 hover:bg-green-800 transition" onclick="toggleMenu()"
                aria-label="Menu">
                <i class="fas fa-bars text-lg"></i>
            </button>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div id="mobile-menu"
        class="hidden bg-piaui-green text-white px-4 py-4 space-y-4 border-t border-green-700 no-print sticky top-[52px] z-[90] shadow-xl">
        <a href="#" onclick="switchView('home')"
            class="block py-2 border-b border-green-700 font-bold uppercase text-xs tracking-widest"><i
                class="fas fa-home mr-3"></i>Início</a>
        <a href="#" onclick="switchView('ranking')"
            class="block py-2 border-b border-green-700 font-bold uppercase text-xs tracking-widest"><i
                class="fas fa-trophy mr-3"></i>Ranking</a>
        <a href="#" onclick="toggleAdminLogin()"
            class="block py-2 text-yellow-300 font-bold uppercase text-xs tracking-widest"><i
                class="fas fa-user-shield mr-3"></i>Acesso Admin</a>
    </div>

    <main class="container mx-auto px-4 mt-6">

        <!-- VIEW: HOME -->
        <section id="view-home" class="view-content">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div>
                    <h2 class="text-xl md:text-2xl font-black text-gray-800 uppercase tracking-tighter">Jogos da Rodada
                    </h2>
                    <p class="text-xs text-gray-500 font-medium">Confira as partidas e palpites registrados!</p>
                </div>
                <div id="user-info"
                    class="bg-white p-3 rounded-xl shadow-sm border-l-4 border-piaui-blue hidden min-w-[200px]">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-[9px] text-gray-400 uppercase font-bold tracking-wider">Acessando como:</p>
                            <p class="font-bold text-piaui-blue text-sm leading-tight" id="display-user-name"></p>
                        </div>
                        <button onclick="logoutPlayer()"
                            class="text-[9px] text-red-500 font-black hover:text-red-700 transition ml-3 bg-red-50 px-2 py-1 rounded-md uppercase border border-red-100">
                            SAIR
                        </button>
                    </div>
                </div>
            </div>

            <!-- Identificação rápida -->
            <div id="auth-box"
                class="bg-white p-5 rounded-2xl shadow-sm mb-6 max-w-md mx-auto no-print border border-gray-100">
                <h3 class="text-sm font-bold mb-3 text-center text-gray-700 uppercase tracking-tight">Identifique-se
                    para palpar</h3>
                <div class="flex space-x-2">
                    <input type="text" id="input-player-name" placeholder="Nome Completo"
                        class="flex-1 border border-gray-200 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 outline-none text-xs transition-all uppercase font-medium">
                    <button onclick="setPlayerName()"
                        class="bg-piaui-green text-white px-5 py-2 rounded-lg font-bold hover:bg-opacity-90 transition active:scale-95 shadow-sm uppercase text-[10px]">Entrar</button>
                </div>
            </div>

            <div id="matches-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <div class="col-span-full flex flex-col items-center justify-center py-10">
                    <div class="loader mb-3"></div>
                    <p class="text-gray-400 font-medium text-xs italic tracking-wider">Sincronizando dados...</p>
                </div>
            </div>
        </section>

        <!-- VIEW: RANKING -->
        <section id="view-ranking" class="view-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl md:text-2xl font-black text-gray-800 uppercase tracking-tighter">Classificação Geral
                </h2>
                <button onclick="exportRankingPDF()"
                    class="bg-blue-600 text-white px-3 py-1.5 rounded-lg hover:bg-blue-700 no-print transition shadow-md font-bold text-[10px] uppercase tracking-widest">
                    <i class="fas fa-file-pdf mr-1"></i>PDF
                </button>
            </div>

            <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-5 py-3 font-black text-gray-400 uppercase text-[9px] tracking-widest">Pos</th>
                            <th class="px-5 py-3 font-black text-gray-400 uppercase text-[9px] tracking-widest">
                                Participante</th>
                            <th
                                class="px-5 py-3 font-black text-gray-400 text-center uppercase text-[9px] tracking-widest">
                                Palpites</th>
                            <th
                                class="px-5 py-3 font-black text-gray-400 text-right uppercase text-[9px] tracking-widest">
                                Pontos</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-table-body"></tbody>
                </table>
            </div>
        </section>

        <!-- VIEW: ADMIN -->
        <section id="view-admin" class="view-content hidden">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-xl font-black text-red-600 flex items-center uppercase tracking-tighter"><i
                        class="fas fa-user-shield mr-2"></i>Painel Admin</h2>
                <div class="flex space-x-2 w-full md:w-auto">
                    <button onclick="openMatchModal()"
                        class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 transition shadow-md text-xs uppercase tracking-widest">
                        <i class="fas fa-plus mr-1"></i>Novo Jogo
                    </button>
                    <button onclick="logoutAdmin()"
                        class="bg-gray-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-gray-700 transition text-[10px] uppercase">Sair</button>
                </div>
            </div>
            <div class="grid grid-cols-1 gap-3" id="admin-matches-list"></div>
        </section>
    </main>

    <!-- Modal: Palpite Individual -->
    <div id="modal-bet" class="modal no-print">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 shadow-2xl border border-gray-100">
            <h3 class="text-lg font-black mb-5 text-center text-piaui-green uppercase tracking-tight"
                id="modal-bet-title">Seu Palpite</h3>
            <div
                class="flex items-center justify-between mb-6 space-x-3 bg-gray-50 p-5 rounded-xl border border-gray-200">
                <div class="text-center flex-1">
                    <p class="font-black text-[9px] mb-2 text-gray-400 uppercase truncate" id="home-team-name"></p>
                    <input type="number" id="bet-home"
                        class="w-14 h-14 text-2xl text-center border-2 border-gray-200 rounded-xl focus:border-piaui-green outline-none bg-white transition-all shadow-sm font-black"
                        min="0" value="0">
                </div>
                <div class="text-xl font-black text-gray-300">X</div>
                <div class="text-center flex-1">
                    <p class="font-black text-[9px] mb-2 text-gray-400 uppercase truncate" id="away-team-name"></p>
                    <input type="number" id="bet-away"
                        class="w-14 h-14 text-2xl text-center border-2 border-gray-200 rounded-xl focus:border-piaui-green outline-none bg-white transition-all shadow-sm font-black"
                        min="0" value="0">
                </div>
            </div>
            <div class="flex flex-col space-y-2">
                <button onclick="saveBet()"
                    class="bg-piaui-green text-white py-3 rounded-xl font-black hover:bg-opacity-90 transition active:scale-95 shadow-md uppercase tracking-widest text-xs">Confirmar</button>
                <button onclick="closeModal('modal-bet')"
                    class="text-gray-400 font-bold py-2 hover:text-gray-600 transition uppercase text-[10px]">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Login Admin -->
    <div id="modal-admin-login" class="modal no-print">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 shadow-2xl border border-gray-100 text-center">
            <h3 class="text-lg font-black mb-4 text-gray-800 uppercase tracking-tight">Acesso Restrito</h3>
            <input type="password" id="admin-pass" placeholder="Senha"
                class="w-full border border-gray-200 rounded-lg px-4 py-3 mb-4 focus:ring-2 focus:ring-red-500 outline-none text-center font-bold">
            <button onclick="loginAdmin()"
                class="w-full bg-red-600 text-white py-3 rounded-xl font-black hover:bg-red-700 transition uppercase tracking-widest text-xs">Entrar</button>
            <button onclick="closeModal('modal-admin-login')"
                class="w-full text-gray-400 font-bold py-2 mt-2 uppercase text-[10px]">Fechar</button>
        </div>
    </div>

    <!-- Modal: Cadastro/Edição de Jogo + Importação em Massa -->
    <div id="modal-match-admin" class="modal no-print">
        <div
            class="bg-white rounded-2xl p-6 max-w-4xl w-full mx-4 shadow-2xl overflow-y-auto max-h-[90vh] border border-gray-200">
            <h3 class="text-xl font-black mb-6 text-center text-gray-800 uppercase tracking-tight"
                id="match-admin-title">Configurar Jogo</h3>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Coluna: Dados do Jogo -->
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-[9px] font-black text-gray-500 mb-1 uppercase">Rodada</label>
                                <input type="text" id="admin-match-round" placeholder="01/07"
                                    class="w-full border border-gray-200 rounded-lg px-3 py-2 text-xs font-bold outline-none">
                            </div>
                            <div>
                                <label class="block text-[9px] font-black text-gray-500 mb-1 uppercase">Data</label>
                                <input type="text" id="admin-match-date" placeholder="10/01 16:00"
                                    class="w-full border border-gray-200 rounded-lg px-3 py-2 text-xs font-bold outline-none">
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="block text-[9px] font-black text-gray-500 mb-1 uppercase">Estádio</label>
                            <input type="text" id="admin-match-stadium" placeholder="Estádio..."
                                class="w-full border border-gray-200 rounded-lg px-3 py-2 text-xs font-bold outline-none">
                        </div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 space-y-3">
                        <div>
                            <label class="block text-[9px] font-black text-gray-500 mb-1 uppercase">Time
                                Mandante</label>
                            <input type="text" id="admin-home-team"
                                class="w-full border border-gray-200 rounded-lg px-3 py-2 text-xs font-black outline-none uppercase">
                        </div>
                        <div>
                            <label class="block text-[9px] font-black text-gray-500 mb-1 uppercase">Time
                                Visitante</label>
                            <input type="text" id="admin-away-team"
                                class="w-full border border-gray-200 rounded-lg px-3 py-2 text-xs font-black outline-none uppercase">
                        </div>
                        <div class="grid grid-cols-2 gap-4 pt-1">
                            <div>
                                <label
                                    class="block text-[9px] font-black text-green-700 mb-1 uppercase text-center">Gols
                                    Casa</label>
                                <input type="number" id="admin-home-score"
                                    class="w-full border-2 border-green-100 rounded-xl px-2 py-2 text-xl font-black text-center outline-none bg-white"
                                    value="0">
                            </div>
                            <div>
                                <label
                                    class="block text-[9px] font-black text-green-700 mb-1 uppercase text-center">Gols
                                    Fora</label>
                                <input type="number" id="admin-away-score"
                                    class="w-full border-2 border-green-100 rounded-xl px-2 py-2 text-xl font-black text-center outline-none bg-white"
                                    value="0">
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center space-x-3 bg-yellow-50 p-3 rounded-xl border border-yellow-200">
                        <input type="checkbox" id="admin-is-finished" class="w-5 h-5 accent-yellow-600 cursor-pointer">
                        <label for="admin-is-finished"
                            class="text-[10px] font-black text-yellow-900 uppercase cursor-pointer tracking-tight">ENCERRAR
                            E CALCULAR PONTOS</label>
                    </div>

                    <div class="pt-1 flex flex-col space-y-2">
                        <button onclick="saveMatchAdmin()"
                            class="bg-blue-600 text-white py-2.5 rounded-lg font-black hover:bg-blue-700 transition shadow-md text-xs uppercase">Gravar
                            Jogo</button>
                        <button onclick="deleteMatchAdmin()" id="btn-delete-match"
                            class="hidden text-red-600 font-bold text-[9px] py-1 hover:bg-red-50 rounded uppercase tracking-wider">Excluir
                            Jogo</button>
                    </div>
                </div>

                <!-- Coluna: Importação -->
                <div class="lg:border-l lg:pl-8 space-y-3">
                    <label class="block text-[10px] font-black text-piaui-green uppercase tracking-widest">Importar
                        Lista de Palpites</label>
                    <textarea id="bulk-bets-input" rows="12"
                        class="w-full border border-gray-200 rounded-xl p-4 text-[11px] font-mono bg-gray-50 focus:bg-white outline-none transition-all shadow-inner"
                        placeholder="0X1 Yan Gabriel&#10;1X3 Hudson"></textarea>
                    <button onclick="processBulkImport()"
                        class="w-full bg-piaui-green text-white py-3 rounded-xl font-black text-[10px] hover:bg-opacity-90 transition shadow-md uppercase tracking-widest">Processar
                        Lista</button>
                </div>
            </div>
            <button onclick="closeModal('modal-match-admin')"
                class="w-full text-gray-400 font-bold text-[9px] mt-6 hover:text-gray-600 uppercase tracking-widest border-t pt-4">Fechar</button>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast"
        class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-2xl shadow-2xl hidden z-[300] border border-gray-700">
        <span id="toast-msg" class="font-bold text-xs uppercase tracking-tight">Mensagem</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAdlBq3u0C5npsi_pB-CYxPJxxlIj1ucYg",
            authDomain: "bolaopiauizao.firebaseapp.com",
            projectId: "bolaopiauizao",
            storageBucket: "bolaopiauizao.firebasestorage.app",
            messagingSenderId: "126657670519",
            appId: "1:126657670519:web:12c310049e4bc69ef84572",
            measurementId: "G-MKSKR9SL5R"
        };
        
        const appId = 'bolao-piauizao-oficial';
        const matchesList = document.getElementById('matches-list');

        let auth, db, appInstance;
        let currentUser = null;
        let isAdmin = false;
        let matches = [];
        let userGuesses = [];
        let activeMatchId = null;
        let playerName = localStorage.getItem('bolao_user_name') || "";
        let unsubs = [];

        async function init() {
            try {
                appInstance = initializeApp(firebaseConfig);
                auth = getAuth(appInstance);
                db = getFirestore(appInstance);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    if (user) {
                        startListeners();
                        if (playerName) setPlayerUI();
                    }
                });
            } catch (err) {
                console.error(err);
                if (matchesList) matchesList.innerHTML = `<div class='col-span-full text-center py-10 text-red-500 text-xs font-bold uppercase tracking-widest'>Erro ao conectar ao banco de dados.</div>`;
            }
        }

        function startListeners() {
            if (!currentUser) return;
            unsubs.forEach(u => u());
            unsubs = [];

            const qMatches = collection(db, 'artifacts', appId, 'public', 'data', 'matches');
            unsubs.push(onSnapshot(qMatches, (snapshot) => {
                matches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMatches();
                renderAdminMatches();
                calculateRanking();
            }));

            const qGuesses = collection(db, 'artifacts', appId, 'public', 'data', 'guesses');
            unsubs.push(onSnapshot(qGuesses, (snapshot) => {
                userGuesses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMatches();
                calculateRanking();
            }));
        }

        // --- RENDER ---
        window.setPlayerName = () => {
            let nameInput = document.getElementById('input-player-name').value.trim();
            if (!nameInput) return showToast("Digite seu nome!");
            playerName = nameInput.toUpperCase();
            localStorage.setItem('bolao_user_name', playerName);
            setPlayerUI();
        };

        window.logoutPlayer = () => {
            playerName = ""; localStorage.removeItem('bolao_user_name');
            document.getElementById('auth-box').classList.remove('hidden');
            document.getElementById('user-info').classList.add('hidden');
            renderMatches();
        };

        function setPlayerUI() {
            document.getElementById('auth-box').classList.add('hidden');
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('display-user-name').innerText = playerName;
            renderMatches();
        }

        function renderMatches() {
            if (!matchesList) return;
            if (matches.length === 0) {
                matchesList.innerHTML = `<div class='col-span-full text-center py-16 text-gray-400 font-bold uppercase text-[10px] tracking-widest italic'>Aguardando jogos...</div>`;
                return;
            }

            const sorted = [...matches].sort((a, b) => (a.round + a.date).localeCompare(b.round + b.date));
            matchesList.innerHTML = sorted.map(match => {
                const isFinished = match.status === 'finished';
                const matchBets = userGuesses.filter(g => g.matchId === match.id);
                const myBet = matchBets.find(g => (g.userName || '').toUpperCase() === playerName);

                return `
                    <div class="card-match bg-white rounded-3xl shadow-sm border border-gray-50 overflow-hidden">
                        <div class="bg-gray-50 px-5 py-3 border-b flex justify-between items-center">
                            <span class="text-[9px] font-black text-piaui-green uppercase tracking-tighter">RODADA ${match.round || '01'}</span>
                            <span class="text-[8px] ${isFinished ? 'text-gray-400 bg-gray-200' : 'text-green-700 bg-green-50'} px-2 py-0.5 rounded-full font-black uppercase">${isFinished ? 'ENCERRADO' : 'ABERTO'}</span>
                        </div>
                        <div class="p-6">
                            <div class="text-center mb-4">
                                <p class="text-[8px] text-gray-300 font-black uppercase tracking-widest mb-0.5">${match.stadium || 'Estádio'}</p>
                                <p class="text-[11px] text-gray-700 font-black">${match.date || '--'}</p>
                            </div>
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-center flex-1">
                                    <div class="w-12 h-12 bg-green-50 rounded-full mx-auto mb-2 flex items-center justify-center font-black text-piaui-green border-2 border-white shadow-sm text-sm">${(match.homeTeam || 'T1').substring(0,3).toUpperCase()}</div>
                                    <p class="text-[10px] font-black text-gray-800 truncate uppercase tracking-tighter">${match.homeTeam || 'Time A'}</p>
                                </div>
                                <div class="px-3 text-center">
                                    <div class="font-black text-2xl md:text-3xl text-piaui-green flex items-center justify-center space-x-2 italic">
                                        ${isFinished ? `<span>${match.homeScore}</span><span class='text-gray-200'>-</span><span>${match.awayScore}</span>` : '<span class="text-gray-100">VS</span>'}
                                    </div>
                                </div>
                                <div class="text-center flex-1">
                                    <div class="w-12 h-12 bg-blue-50 rounded-full mx-auto mb-2 flex items-center justify-center font-black text-piaui-blue border-2 border-white shadow-sm text-sm">${(match.awayTeam || 'T2').substring(0,3).toUpperCase()}</div>
                                    <p class="text-[10px] font-black text-gray-800 truncate uppercase tracking-tighter">${match.awayTeam || 'Time B'}</p>
                                </div>
                            </div>
                            
                            <div class="mt-8 pt-5 border-t border-dashed border-gray-100">
                                ${myBet ? `
                                    <div class="bg-piaui-green bg-opacity-5 p-4 rounded-2xl flex justify-between items-center shadow-inner">
                                        <div>
                                            <p class="text-[8px] text-gray-400 uppercase font-black mb-1">Seu Palpite</p>
                                            <p class="text-xl font-black text-piaui-green">${myBet.homeBet} <span class='text-gray-200 mx-0.5'>x</span> ${myBet.awayBet}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-[8px] text-gray-400 uppercase font-black mb-1">Pontos</p>
                                            <p class="text-2xl font-black ${Number(myBet.points) > 0 ? 'text-blue-600' : 'text-gray-200'}">${isFinished ? (myBet.points || 0) : '--'}</p>
                                        </div>
                                    </div>
                                ` : `
                                    <button onclick="openBetModal('${match.id}')" ${isFinished ? 'disabled' : ''} class="w-full py-4 bg-piaui-yellow text-piaui-green font-black rounded-2xl text-[10px] uppercase tracking-widest transition shadow-sm ${isFinished ? 'opacity-30 cursor-not-allowed shadow-none' : 'hover:scale-[1.01] active:scale-95'}">
                                        Lançar Palpite
                                    </button>
                                `}
                                <button onclick="toggleDetails('${match.id}')" class="w-full mt-4 text-[9px] text-gray-300 font-black hover:text-piaui-green uppercase tracking-widest transition-colors flex items-center justify-center">
                                    <i class="fas fa-eye mr-2"></i>Palpites (${matchBets.length})
                                </button>
                                <div id="details-${match.id}" class="hidden mt-4 space-y-1.5 max-h-40 overflow-y-auto pr-2 custom-scrollbar">
                                    ${matchBets.map(b => `
                                        <div class="flex justify-between items-center text-[9px] p-2 bg-gray-50 rounded-xl border border-gray-100">
                                            <span class="truncate font-black text-gray-600 uppercase tracking-tighter">${b.userName}</span>
                                            <div class="flex items-center space-x-3">
                                                <span class="font-black text-piaui-green">${b.homeBet}x${b.awayBet}</span>
                                                ${isFinished ? `<span class="bg-white px-1.5 py-0.5 rounded border border-gray-200 font-black ${Number(b.points) > 0 ? 'text-blue-600' : 'text-gray-300'}">${b.points} Pt</span>` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.toggleDetails = (id) => document.getElementById(`details-${id}`).classList.toggle('hidden');

        function calculateRanking() {
            const userTotals = {};
            const activeMatchIds = new Set(matches.map(m => m.id));

            userGuesses.forEach(guess => {
                if (!activeMatchIds.has(guess.matchId)) return;
                const name = (guess.userName || 'ANÔNIMO').trim().toUpperCase();
                if (!userTotals[name]) userTotals[name] = { name: name, points: 0, count: 0 };
                userTotals[name].points += Number(guess.points || 0);
                userTotals[name].count += 1;
            });

            const sorted = Object.values(userTotals).sort((a, b) => b.points - a.points || b.count - a.count);
            const rt = document.getElementById('ranking-table-body');
            if (rt) {
                if (sorted.length === 0) {
                    rt.innerHTML = `<tr><td colspan='4' class='text-center py-16 text-gray-300 font-black uppercase text-[10px] tracking-widest italic opacity-50'>Aguardando resultados...</td></tr>`;
                } else {
                    rt.innerHTML = sorted.map((u, i) => `
                        <tr class="${u.name === playerName ? 'bg-green-50 border-l-4 border-l-piaui-green' : ''} border-b border-gray-50">
                            <td class="px-5 py-4 font-black text-gray-400 text-xs italic">${i + 1}º</td>
                            <td class="px-5 py-4">
                                <div class="flex items-center">
                                    <span class="font-black text-gray-800 uppercase tracking-tighter text-xs">${u.name}</span>
                                    ${u.name === playerName ? '<span class="ml-2 text-[7px] bg-green-600 text-white px-1.5 py-0.5 rounded font-black shadow-sm">VOCÊ</span>' : ''}
                                </div>
                            </td>
                            <td class="px-5 py-4 text-center text-gray-500 font-black text-xs">${u.count}</td>
                            <td class="px-5 py-4 text-right font-black text-piaui-green text-xl">${u.points}</td>
                        </tr>
                    `).join('');
                }
            }
        }

        // --- IMPORT & ADMIN ---
        window.processBulkImport = async () => {
            if (!activeMatchId) return showToast("Grave o jogo primeiro!");
            const input = document.getElementById('bulk-bets-input').value;
            const lines = input.split('\n');
            let count = 0;
            const batch = writeBatch(db);

            // Verificação de pontuação se o jogo já estiver encerrado
            const match = matches.find(m => m.id === activeMatchId);
            const isFinished = match?.status === 'finished';
            const realResult = match ? (match.homeScore > match.awayScore ? 'home' : (match.homeScore < match.awayScore ? 'away' : 'draw')) : null;

            lines.forEach(line => {
                const res = line.match(/(\d+)\s*[xX]\s*(\d+)\s+(.+)/i);
                if (res) {
                    const hB = parseInt(res[1]);
                    const aB = parseInt(res[2]);
                    const name = res[3].trim().toUpperCase();
                    
                    let pts = 0;
                    if (isFinished && realResult) {
                        const betResult = hB > aB ? 'home' : (hB < aB ? 'away' : 'draw');
                        if (betResult === realResult) pts = (realResult === 'draw') ? 1 : 3;
                    }

                    const betRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'guesses'));
                    batch.set(betRef, { matchId: activeMatchId, userName: name, homeBet: hB, awayBet: aB, points: pts, timestamp: Date.now() });
                    count++;
                }
            });

            if (count > 0) {
                await batch.commit();
                showToast(`${count} palpites importados!`);
                document.getElementById('bulk-bets-input').value = "";
            } else showToast("Formato: 2x1 Nome");
        };

        window.saveMatchAdmin = async () => {
            const isFin = document.getElementById('admin-is-finished').checked;
            const hS = parseInt(document.getElementById('admin-home-score').value) || 0;
            const aS = parseInt(document.getElementById('admin-away-score').value) || 0;
            const data = {
                round: document.getElementById('admin-match-round').value || "01",
                date: document.getElementById('admin-match-date').value || "",
                stadium: document.getElementById('admin-match-stadium').value || "",
                homeTeam: document.getElementById('admin-home-team').value || "TIME A",
                awayTeam: document.getElementById('admin-away-team').value || "TIME B",
                homeScore: hS, awayScore: aS, status: isFin ? 'finished' : 'open'
            };

            try {
                let mId = activeMatchId;
                if (activeMatchId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', activeMatchId), data);
                else {
                    const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'matches'), data);
                    mId = docRef.id;
                    activeMatchId = mId;
                }
                if (isFin) await processPoints(mId, hS, aS);
                showToast("Sucesso!");
                renderAdminMatches();
                if (isFin) closeModal('modal-match-admin');
            } catch (err) { showToast("Erro no servidor."); }
        };

        async function processPoints(matchId, realH, realA) {
            const realResult = realH > realA ? 'home' : (realH < realA ? 'away' : 'draw');
            const q = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'guesses'));
            const bets = q.docs.map(d => ({id: d.id, ...d.data()})).filter(g => g.matchId === matchId);
            
            const batch = writeBatch(db);
            bets.forEach(b => {
                const betRes = b.homeBet > b.awayBet ? 'home' : (b.homeBet < b.awayBet ? 'away' : 'draw');
                let pts = (betRes === realResult) ? (realResult === 'draw' ? 1 : 3) : 0;
                batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'guesses', b.id), { points: Number(pts) });
            });
            if (bets.length > 0) await batch.commit();
        }

        // --- AUX ---
        window.toggleMenu = () => document.getElementById('mobile-menu').classList.toggle('hidden');
        window.switchView = (v) => {
            document.querySelectorAll('.view-content').forEach(s => s.classList.add('hidden'));
            document.getElementById(`view-${v}`).classList.remove('hidden');
            document.getElementById('mobile-menu').classList.add('hidden');
            window.scrollTo(0,0);
        };
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');
        window.showToast = (m) => {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = m;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3500);
        };
        window.openMatchModal = (id = null) => {
            activeMatchId = id;
            const m = matches.find(x => x.id === id);
            document.getElementById('btn-delete-match').style.display = id ? 'block' : 'none';
            document.getElementById('admin-match-round').value = m?.round || "";
            document.getElementById('admin-match-date').value = m?.date || "";
            document.getElementById('admin-match-stadium').value = m?.stadium || "";
            document.getElementById('admin-home-team').value = m?.homeTeam || "";
            document.getElementById('admin-away-team').value = m?.awayTeam || "";
            document.getElementById('admin-home-score').value = m?.homeScore || 0;
            document.getElementById('admin-away-score').value = m?.awayScore || 0;
            document.getElementById('admin-is-finished').checked = m?.status === 'finished';
            document.getElementById('modal-match-admin').classList.add('active');
        };
        window.toggleAdminLogin = () => isAdmin ? switchView('admin') : document.getElementById('modal-admin-login').classList.add('active');
        window.loginAdmin = () => {
            if (document.getElementById('admin-pass').value === "piaui2024") {
                isAdmin = true; closeModal('modal-admin-login'); switchView('admin');
            } else showToast("Senha inválida!");
        };
        window.renderAdminMatches = () => {
            const l = document.getElementById('admin-matches-list');
            if (l) l.innerHTML = matches.map(m => `
                <div onclick="openMatchModal('${m.id}')" class="bg-white p-4 rounded-2xl border border-gray-100 cursor-pointer flex justify-between items-center transition group">
                    <div>
                        <span class="text-[8px] font-black text-gray-400 bg-gray-50 px-2 py-0.5 rounded uppercase">R${m.round}</span> 
                        <div class="font-black mt-1 text-gray-800 uppercase tracking-tighter text-xs">${m.homeTeam} ${m.homeScore} x ${m.awayScore} ${m.awayTeam}</div>
                    </div>
                    <i class="fas fa-edit text-gray-200 group-hover:text-piaui-green transition-colors text-sm"></i>
                </div>
            `).join('');
        };
        window.openBetModal = (id) => {
            if (!playerName) return showToast("Identifique-se primeiro!");
            activeMatchId = id;
            const m = matches.find(x => x.id === id);
            document.getElementById('home-team-name').innerText = m.homeTeam;
            document.getElementById('away-team-name').innerText = m.awayTeam;
            document.getElementById('modal-bet').classList.add('active');
        };
        window.saveBet = async () => {
            const hb = parseInt(document.getElementById('bet-home').value) || 0;
            const ab = parseInt(document.getElementById('bet-away').value) || 0;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'guesses'), { matchId: activeMatchId, userName: playerName.trim().toUpperCase(), homeBet: hb, awayBet: ab, points: 0, timestamp: Date.now() });
                closeModal('modal-bet'); showToast("Sucesso!");
            } catch(e) { showToast("Erro."); }
        };
        window.deleteMatchAdmin = async () => {
            if (!activeMatchId || !confirm("Remover jogo e palpites?")) return;
            const q = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'guesses'));
            const bets = q.docs.filter(d => d.data().matchId === activeMatchId);
            const batch = writeBatch(db);
            batch.delete(doc(db, 'artifacts', appId, 'public', 'data', 'matches', activeMatchId));
            bets.forEach(b => batch.delete(doc(db, 'artifacts', appId, 'public', 'data', 'guesses', b.id)));
            await batch.commit();
            closeModal('modal-match-admin');
            showToast("Dados removidos.");
        };
        window.exportRankingPDF = () => window.print();

        init();
    </script>
</body>

</html>